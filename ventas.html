<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ventas por Semana · Gummy Bank</title>

  <!-- Bloqueo temprano -->
  <script>
    if (sessionStorage.getItem("ventas_auth") !== "true") {
      window.location.replace("index.html");
    }
  </script>

  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <link rel="stylesheet" href="css/ventas.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="topbar glass">
      <h1>Panel de Ventas por Semana</h1>
      <div class="spacer"></div>
      <button id="logoutBtn" class="btn danger">Cerrar sesión</button>
    </header>

    <!-- 0 · Guía -->
    <section class="panel">
      <h2>Guía rápida</h2>
      <ul class="guide">
        <li><b>Catálogo global:</b> crea/renombra escuelas. Se usan en todas las semanas.</li>
        <li><b>Semana activa:</b> elige semana, ponle <b>etiqueta</b> propia, crea y asegura escuelas.</li>
        <li><b>Registro:</b> agrega movimientos o usa <b>Carrito</b> y luego <b>Registrar todo</b>.</li>
        <li><b>Resultados:</b> corrige con <b>Modo edición</b> si metiste cantidades de más.</li>
        <li><b>Semanas creadas:</b> abre, renombra etiqueta o <b>elimina</b> semanas.</li>
      </ul>
    </section>

    <!-- 1 · Catálogo de escuelas -->
    <section class="panel">
      <div class="panel-head">
        <h2>Catálogo de escuelas (global)</h2>
        <div class="toolbar">
          <button id="btnAddSchoolGlobal" class="btn">Nueva escuela</button>
          <button id="btnSyncNombresSemana" class="btn">Sincronizar nombres a semana activa</button>
        </div>
      </div>
      <div id="escuelasCatalogo" class="grid-4"></div>
    </section>

    <!-- 2 · Semana activa -->
    <section class="panel">
      <h2>Semana activa</h2>
      <div class="grid-4">
        <label class="field">
          <span>Clave de semana (ISO) · ej. 2025-W36</span>
          <input type="week" id="weekInput"/>
        </label>
        <label class="field">
          <span>Etiqueta visible de la semana (nombre libre)</span>
          <input id="weekLabelInput" placeholder="Semana Regreso a Clases"/>
        </label>
        <div class="stack">
          <button id="btnCreateWeek" class="btn">Crear/abrir semana</button>
          <button id="btnEnsureSchools" class="btn">Asegurar escuelas</button>
        </div>
        <label class="field">
          <span>Escuela para registrar</span>
          <select id="schoolSelect"></select>
        </label>
      </div>
    </section>

    <!-- 3 · Registro -->
    <section class="panel">
      <div class="panel-head">
        <h2>Registro de movimientos</h2>
        <div class="toolbar">
          <button id="btnAddAll" class="btn primary">Registrar todo</button>
          <button id="btnClearAll" class="btn gray">Vaciar carrito</button>
        </div>
      </div>

      <div class="grid-4">
        <div class="card">
          <h3>Asignar bolsas</h3>
          <label class="field"><span>Cantidad</span><input id="inpAsignadas" type="number" min="0" step="1" value="0"/></label>
          <div class="row">
            <button id="btnAsignar" class="btn">Registrar</button>
            <button id="addAsignadasToBatch" class="btn ghost">Al carrito</button>
          </div>
          <p class="hint">Aumenta asignadas. Inversión = asignadas × 11.80.</p>
        </div>

        <div class="card">
          <h3>Ventas</h3>
          <label class="field"><span>Bolsas vendidas</span><input id="inpVendidas" type="number" min="0" step="1" value="0"/></label>
          <label class="field"><span>Precio bolsa (MXN)</span><input id="inpPrecio" type="number" min="0" step="0.5" value="25"/></label>
          <div class="row">
            <button id="btnVender" class="btn">Registrar</button>
            <button id="addVentasToBatch" class="btn ghost">Al carrito</button>
          </div>
          <p class="hint">Pago vendedor = vendidas × 5.</p>
        </div>

        <div class="card">
          <h3>Premios</h3>
          <label class="field"><span>Gomitas (cantidad)</span><input id="inpGomitas" type="number" min="0" step="1" value="0"/></label>
          <label class="field"><span>Premios en dinero (MXN)</span><input id="inpPremioDinero" type="number" min="0" step="1" value="0"/></label>
          <div class="row">
            <button id="btnPremiar" class="btn">Registrar</button>
            <button id="addPremiosToBatch" class="btn ghost">Al carrito</button>
          </div>
          <p class="hint">Cada gomita descuenta $11.80 de ventas y 1 asignada. Dinero descuenta de ventas.</p>
        </div>

        <div class="card">
          <h3>Gastos variables</h3>
          <label class="field"><span>Monto (MXN)</span><input id="inpGastos" type="number" min="0" step="1" value="0"/></label>
          <div class="row">
            <button id="btnGasto" class="btn">Registrar</button>
            <button id="addGastoToBatch" class="btn ghost">Al carrito</button>
          </div>
          <p class="hint">Para stickers, transporte, drama y demás.</p>
        </div>
      </div>

      <details class="cart">
        <summary>Carrito de registros (<span id="cartCount">0</span>)</summary>
        <ul id="cartList"></ul>
      </details>
    </section>

    <!-- 4 · Resultados semana -->
    <section class="panel">
      <div class="panel-head">
        <h2>Resultados de la semana</h2>
        <div class="toolbar">
          <label class="switch">
            <input type="checkbox" id="toggleEdit"/>
            <span>Modo edición</span>
          </label>
          <button id="btnSaveEdits" class="btn" disabled>Guardar cambios</button>
          <button id="btnCancelEdits" class="btn gray" disabled>Cancelar</button>
        </div>
      </div>

      <div class="tableWrap">
        <table class="grid" id="tblSemana">
          <thead>
            <tr>
              <th>Escuela</th>
              <th class="num">Asignadas</th>
              <th class="num">Vendidas</th>
              <th class="num">Restantes</th>
              <th class="num">Precio</th>
              <th class="num">Gomitas</th>
              <th class="num">Gomitas $</th>
              <th class="num">Premio $</th>
              <th class="num">Gastos var</th>
              <th class="num">Inversión</th>
              <th class="num">Pago vendedor</th>
              <th class="num">Total ventas</th>
              <th class="num">Neta</th>
            </tr>
          </thead>
          <tbody id="tbodySemana"></tbody>
        </table>
      </div>
      <div id="totalesSemana" class="sum"></div>

      <div class="cards">
        <div class="card">
          <h3>Neta por escuela</h3>
          <canvas id="barSemana"></canvas>
        </div>
        <div class="card">
          <h3>Composición semanal</h3>
          <canvas id="pieSemana"></canvas>
        </div>
      </div>
    </section>

    <!-- 5 · Semanas creadas -->
    <section class="panel">
      <div class="panel-head">
        <h2>Semanas creadas</h2>
        <div class="toolbar">
          <label class="field">
            <span>Buscar</span>
            <input id="searchWeek" placeholder="2025 o W36 o etiqueta"/>
          </label>
        </div>
      </div>

      <div id="weeksList" class="weeks-list"></div>

      <div class="card" style="margin-top:12px">
        <h3>Neta total por semana</h3>
        <canvas id="lineSemanas"></canvas>
      </div>
    </section>
  </div>

  <!-- Toasts -->
  <div id="toasts"></div>

  <!-- Modal -->
  <div id="confirmModal">
    <div id="confirmBox">
      <h3 id="confirmTitle">Confirmar</h3>
      <p id="confirmMsg"></p>
      <div id="confirmBtns">
        <button id="cancelBtn" class="btn gray">Cancelar</button>
        <button id="okBtn" class="btn danger">OK</button>
      </div>
    </div>
  </div>

  <script type="module" src="js/ventas.js"></script>
</body>
</html>
