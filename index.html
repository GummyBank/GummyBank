<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width,initial-scale=1" name="viewport" />
    <title>GummyBank</title>
    <link href="css/styles.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
/* ====== Marca/Im√°genes ====== */
#logo-gummy-bank{width:90vw;max-width:1000px;height:auto;display:block;margin:20px auto}
.imagen-recompensa{width:90vw;max-width:1000px;height:auto;display:block;margin:20px auto;margin-left:-5px}
.imagen-madera-ajustada{transform:scale(1.04);margin-left:-15px}

/* ====== B√≥vedas ====== */
.vault.cristal{box-shadow:0 0 20px rgba(0,255,255,.5);border:2px solid rgba(0,255,255,.4)}
.vault.plateada{box-shadow:0 0 20px rgba(200,200,200,.5);border:2px solid rgba(180,180,180,.4)}
.vault.dorada{box-shadow:0 0 20px rgba(255,215,0,.5);border:2px solid rgba(255,215,0,.4)}
.vault.cristal button{background:linear-gradient(90deg,#00eaff,#00bfff)}
.vault.plateada button{background:linear-gradient(90deg,#aaa,#ddd);color:#000}
.vault.dorada button{background:linear-gradient(90deg,gold,#f90)}
.vault.madera{box-shadow:0 0 20px rgba(139,69,19,.6);border:2px solid rgba(160,82,45,.5);background:linear-gradient(135deg,#8b5a2b,#deb887);color:#fff}
.vault.madera button{background:linear-gradient(90deg,#8b4513,#d2b48c);color:#fff}

/* ====== Lluvia: SIEMPRE al fondo ====== */
#lluvia-container{position:fixed;inset:0;z-index:-1;pointer-events:none}
main,header,section.rewards,#mini-juego,.vault{position:relative;z-index:1}

/* ====== Modales ====== */
.modal-overlay{position:fixed;inset:0;display:none;z-index:10040;background:rgba(0,0,0,.55);backdrop-filter:blur(2px)}
.custom-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:10050}

/* ====== Modal de registro ====== */
#modal-registro.custom-modal{width:min(420px,92vw);padding:18px 16px}
#modal-registro{max-width:420px;width:92vw;box-sizing:border-box}
#modal-registro h2{margin:0 0 12px;font-size:20px;color:#e7ecf3;text-align:center}
#modal-registro form{margin:0;display:grid;gap:10px}
#modal-registro input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2b3b55;background:#0f172a;color:#e7ecf3;outline:none;box-sizing:border-box}
#modal-registro input::placeholder{color:#8aa0c2}
#modal-registro input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
#modal-registro .acciones{display:grid;gap:8px;margin-top:4px}
#modal-registro button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid transparent;font-weight:600;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease,filter .12s ease;box-sizing:border-box}
#modal-registro button[type="submit"]{background:linear-gradient(90deg,#22c55e,#84cc16);color:#0b1220}
#modal-registro button[type="button"]{background:#111827;color:#e5e7eb;border-color:#263042}
#modal-registro button:active{transform:translateY(1px)}
body.modal-open{overflow:hidden}
#modal-registro input,#modal-registro button{pointer-events:auto}

    </style>
  </head>

  <body>
    <div id="lluvia-container" aria-hidden="true"></div>
    <header>
      <div class="top-bar">
        <div class="left-group">
          <a href="https://www.instagram.com/gummybank?igsh=MW82Z3hvN2VjbWYxZw%3D%3D&utm_source=qr" target="_blank" style="text-decoration:none">
            <i class="bi bi-instagram"><span> gummybank</span></i>
          </a>
        </div>
        <div class="icon-question" style="display:flex;align-items:center;gap:10px">
          <i class="bi bi-info-circle" aria-label="Informaci√≥n"></i>
          <span id="lock-icon" style="cursor:pointer;font-size:20px" aria-label="Administrador">üîí</span>
        </div>
      </div>
    </header>

    <main>
      <div id="lluvia-container"></div>

      <div class="animated-bag">
        <img alt="Gummy Bank" src="img/titulo.jpg" id="logo-gummy-bank" />
      </div>

      <!-- ================== TEASER: NUEVO JUEGO PR√ìXIMAMENTE ================== 
<section id="teaser-nuevo-juego" style="width:92%;max-width:920px;margin:28px auto 48px;isolation:isolate">
  <style>
    /* Scope para evitar choques de estilos */
    #teaser-nuevo-juego{
      --bg:#0b1220; --panel:#0f172a; --line:#2b3750; --ink:#e7ecf3; --muted:#9fb0c9;
      --accent1:#22d3ee; --accent2:#a78bfa; --accent3:#34d399; --glow:rgba(34,211,238,.25);
      position:relative;
    }
    #teaser-nuevo-juego .wrap{
      position:relative;border-radius:20px;border:1px solid var(--line);
      padding:18px; background:
        radial-gradient(900px 400px at 10% -10%, rgba(167,139,250,.16), transparent 60%),
        radial-gradient(900px 400px at 110% 110%, rgba(52,211,153,.14), transparent 60%),
        linear-gradient(180deg, rgba(31,41,55,.35), transparent 40%),
        var(--panel);
      box-shadow:0 24px 80px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.02);
      overflow:hidden;
    }
    /* Glow orbes de fondo */
    #teaser-nuevo-juego .orb{
      position:absolute; border-radius:999px; filter:blur(32px); opacity:.6; mix-blend-mode:screen;
      animation: floaty 9s ease-in-out infinite;
    }
    #teaser-nuevo-juego .orb.a{ width:220px; height:220px; background:radial-gradient(circle at 30% 30%, var(--accent1), transparent 60%); top:-40px; left:-40px; }
    #teaser-nuevo-juego .orb.b{ width:260px; height:260px; background:radial-gradient(circle at 70% 70%, var(--accent2), transparent 60%); bottom:-60px; right:-60px; animation-delay: -2s; }
    @keyframes floaty{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

    /* Header */
    #teaser-nuevo-juego .header{
      text-align:center; color:var(--ink); margin:6px 8px 10px;
    }
    #teaser-nuevo-juego .kicker{
      display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      font-size:12px; letter-spacing:.35px; text-transform:uppercase; color:var(--muted);
      background:rgba(2,6,23,.5);
    }
    #teaser-nuevo-juego .title{
      margin:6px 0 0; line-height:1.02; font-weight:900;
      font-size:clamp(28px, 6.5vw, 56px);
      letter-spacing:.2px;
      background:linear-gradient(90deg, var(--accent1), var(--accent2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 10px 36px var(--glow);
    }
    #teaser-nuevo-juego .subtitle{
      margin:6px auto 0; color:#cbd5e1; font-size:clamp(14px,2.7vw,18px); max-width:60ch;
    }

    /* Countdown */
    #teaser-nuevo-juego .countdown{
      margin:16px auto 8px; width:min(760px, 96%); display:grid; gap:10px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    #teaser-nuevo-juego .slot{
      position:relative; background:linear-gradient(135deg, #0e1420, #0b0f18);
      border:1px solid var(--line); border-radius:16px; padding:14px 10px;
      text-align:center; color:var(--ink); box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    #teaser-nuevo-juego .num{
      font-weight:900; line-height:1; letter-spacing:.5px;
      font-size:clamp(26px, 7.2vw, 42px);
      text-shadow:0 8px 26px rgba(0,0,0,.35);
    }
    #teaser-nuevo-juego .label{
      display:block; margin-top:4px; color:var(--muted); font-size:clamp(11px,2.7vw,13px); letter-spacing:.3px;
      text-transform:uppercase;
    }

    /* Footer con fecha y CTA fantasma */
    #teaser-nuevo-juego .footer{
      margin:14px auto 6px; text-align:center; color:var(--muted);
      font-size:clamp(12px,2.5vw,14px);
    }

    /* Responsive tweaks */
    @media (max-width:560px){
      #teaser-nuevo-juego .wrap{ padding:14px }
      #teaser-nuevo-juego .countdown{ gap:8px }
      #teaser-nuevo-juego .slot{ padding:12px 8px; border-radius:14px }
    }
  </style>

  <div class="wrap">
    <div class="orb a"></div>
    

    <header class="header">
      <span class="kicker">NUEVO JUEGO</span>
      <h2 class="title">PR√ìXIMAMENTE</h2>
      <p class="subtitle">Cuenta regresiva para el lanzamiento del nuevo juego. Prueba tu suerte.</p>
    </header>

    <div class="countdown" aria-live="polite">
      <div class="slot"><div id="cd-days" class="num">--</div><span class="label">D√≠as</span></div>
      <div class="slot"><div id="cd-hours" class="num">--</div><span class="label">Horas</span></div>
      <div class="slot"><div id="cd-mins" class="num">--</div><span class="label">Min</span></div>
      <div class="slot"><div id="cd-secs" class="num">--</div><span class="label">Seg</span></div>
    </div>

    <p id="cd-footer" class="footer">Lunes 1 de septiembre</p>
  </div>

  <script>
    // Objetivo: Lunes 1 septiembre 2025 07:00 AM (hora local del visitante)
    // Mes 0-indexado: 8 = septiembre
    const TARGET = new Date(2025, 8, 1, 7, 0, 0, 0);

    const elDays = document.getElementById('cd-days');
    const elHours = document.getElementById('cd-hours');
    const elMins = document.getElementById('cd-mins');
    const elSecs = document.getElementById('cd-secs');
    const elFooter = document.getElementById('cd-footer');

    function pad(n){ return n < 10 ? '0' + n : '' + n; }

    function render(){
      const now = new Date();
      let diff = TARGET - now;

      if (diff <= 0){
        // Si ya es la hora, congelamos a 00 y cambiamos leyenda
        elDays.textContent = '00';
        elHours.textContent = '00';
        elMins.textContent = '00';
        elSecs.textContent = '00';
        elFooter.textContent = '¬°ES HOY! 7:00 AM';
        return;
      }

      const sec = Math.floor(diff / 1000);
      const days = Math.floor(sec / 86400);
      const hrs  = Math.floor((sec % 86400) / 3600);
      const mins = Math.floor((sec % 3600) / 60);
      const secs = sec % 60;

      elDays.textContent  = pad(days);
      elHours.textContent = pad(hrs);
      elMins.textContent  = pad(mins);
      elSecs.textContent  = pad(secs);
    }

    render();
    const _cdTimer = setInterval(()=>{
      render();
      if (new Date() >= TARGET) clearInterval(_cdTimer);
    }, 1000);
  </script>
</section>
================== FIN TEASER ================== -->

<!-- ====== BARRA PROMO 40px CON COUNTDOWN A LAS 5:00 PM ====== -->

<div id="MG-promo-bar" role="status" aria-live="polite">
  <center>
  <span class="MG-promo-blink">El nuevo evento termina en:</span>
  <span class="MG-promo-timer" id="MG-countdown">00:00:00</span>
</div>

<style>
  /* Barra 40px full width, sin espacios */
  #MG-promo-bar{
    width:99%;
    height:40px; min-height:40px;
    margin:0 !important; padding:0 12px;
    display:flex; align-items:center; justify-content:center; gap:10px;
    background:
      linear-gradient(90deg,#e90e0e, #ff1500 45%, #360505 85%);
    color:#ffffff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    font-weight:900; text-transform:uppercase; letter-spacing:.6px;
    box-shadow:0 6px 18px rgba(0,0,0,.22), inset 0 0 24px rgba(255,255,255,.06);
    margin-top: 100px; /* se mueve 40px hacia abajo */
  }
  /* Texto que parpadea */
  .MG-promo-blink{ animation:MGblink 1s steps(2,start) infinite; }
  @keyframes MGblink{ 50%{ opacity:.35 } }

  /* Puntero/bala entre texto y timer */
  .MG-promo-sep{ opacity:.85; font-weight:900 }

  /* Timer legible dentro de 40px */
  .MG-promo-timer{
    font-variant-numeric:tabular-nums;
    padding:4px 10px; border-radius:999px;
    background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.12);
  }

  /* Respeta usuarios con reduce-motion */
  @media (prefers-reduced-motion: reduce){
    .MG-promo-blink{ animation:none }
  }
</style>

<script>
  // Cuenta regresiva al pr√≥ximo 5:00 PM (hora local)
  (function(){
    const el = document.getElementById('MG-countdown');
    if(!el) return;

    function two(n){ return n.toString().padStart(2,'0'); }

    function nextFivePM(){
      const now = new Date();
      const t = new Date();
      t.setHours(17,0,0,0);            // 17:00:00 local
      if(now >= t) t.setDate(t.getDate()+1);
      return t;
    }

    let target = nextFivePM();

    function tick(){
      const now = new Date();
      let diff = target - now;

      // Si lleg√≥ a cero, reinicia para el siguiente d√≠a 17:00
      if (diff <= 0){
        target = nextFivePM();
        diff = target - now;
      }

      const s = Math.floor(diff/1000);
      const hh = Math.floor(s/3600);
      const mm = Math.floor((s%3600)/60);
      const ss = s%60;

      el.textContent = `${two(hh)}:${two(mm)}:${two(ss)}`;
    }

    tick();
    setInterval(tick, 1000);
  })();
</script>
<!-- Bloque compacto ¬∑ GummyBank ¬∑ pega tal cual -->
<!-- ====== CARD: Deja tu rese√±a ¬∑ GummyBank ====== -->
<!-- ====== CARD: Deja tu rese√±a ¬∑ GummyBank (no modal) ====== -->
<section class="gb-review-card" aria-labelledby="grc-title">
  <center>
  <h3 id="grc-title">Tu opini√≥n cuenta</h3>
  <p class="grc-sub">
    <center>
    D√©janos tu rese√±a y participa por
    <strong class="grc-badge">5 paquetes de gomitas y $100 pesos</strong>
    <span class="grc-meta">Entrega: <strong>Lunes</strong></span>
    </center>
  </p>
  </center>

  <form id="grc-form" novalidate>
    <label class="grc-lab" for="grc-tel">N√∫mero de tel√©fono (Tu boleto)</label>
    <input id="grc-tel" name="telefono" inputmode="numeric" autocomplete="tel"
           placeholder="10 d√≠gitos" class="grc-inp" required minlength="8" maxlength="15" />

    <label class="grc-lab" for="grc-txt">Tu rese√±a (Confirmacion de participaci√≥n)</label>
    <textarea id="grc-txt" name="resena" class="grc-ta" rows="4"
              placeholder="¬øQu√© te parece GummyBank?" required minlength="5" maxlength="600"></textarea>

    <div class="grc-row">
      <small id="grc-count" class="grc-muted">0/600</small>
      <div class="grc-spacer"></div>
      <button id="grc-send" class="gb-cta" type="submit" disabled>Enviar rese√±a</button>
    </div>

    <p id="grc-msg" class="grc-msg" aria-live="polite"></p>
  </form>
</section>

<style>
  :root{
  --bg:#0f1115; --panel:#11151d; --line:#243041; --ink:#e7ecf3;
  --muted:#9fb0c9; --accent:#1f6feb; --accent-2:#00bfff;
  --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
}

/* ===== Card base ===== */
.gb-review-card{
  /* que NO tape la lluvia */
  position: relative;      /* la card queda sobre la lluvia */
  z-index: 1;

  max-width: min(92vw, 560px);
  width: 100%;
  margin: 18px auto;
  padding: 14px;
  border-radius: 16px;

  font-family: system-ui, -apple-system, Segoe UI, Roboto, Poppins, sans-serif;
  color: var(--ink);
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.16));
  border: 1px solid color-mix(in srgb, var(--line), transparent 35%);
  box-shadow: 0 8px 24px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.04);

  box-sizing: border-box;
  overflow: hidden;  /* solo corta cosas DENTRO de la card, no la lluvia global */
  /* contain: inline-size;  ‚Üê si tu lluvia est√° dentro del mismo √°rbol, puede dar lata. Mejor qu√≠talo. */
}
.gb-review-card *, .gb-review-card *::before, .gb-review-card *::after{
  box-sizing: inherit;
  -webkit-tap-highlight-color: transparent;
  min-width: 0;
}

/* ===== Tipograf√≠a y subt√≠tulo ===== */
.gb-review-card h3{
  margin: 0 0 6px;
  font-size: clamp(16px, 2.4vw, 20px);
}
.grc-sub{
  margin: 0 0 12px;
  font-size: clamp(12px, 2vw, 14px);
  color: var(--muted);
  display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
  overflow-wrap: anywhere;
}
.grc-badge{
  display: inline-block; padding: 2px 8px; border-radius: 999px;
  background: radial-gradient(120% 120% at 20% 20%, #ffe9b0, #f4b400 55%, #b87b00 100%);
  color:#1a1200; font-weight:700; white-space:nowrap;
  box-shadow: 0 2px 10px rgba(248,191,63,.35), inset 0 1px 2px rgba(255,255,255,.35);
}
.grc-meta{ margin-left: auto }

/* ===== Inputs ===== */
.grc-lab{ display:block; margin:8px 2px 6px; font-size:13px; color:var(--muted) }
.grc-inp, .grc-ta{
  width: 100%;
  border-radius: 12px;
  border: 1px solid color-mix(in srgb, var(--line), transparent 35%);
  background:#121722; color: var(--ink);
  padding: 10px 12px;
  font-size: 16px; /* evita auto-zoom en iOS */
  outline: none;
}
.grc-inp:focus, .grc-ta:focus{
  border-color: var(--accent-2);
  box-shadow: 0 0 0 3px rgba(0,191,255,.18);
}

/* ===== Row bot√≥n/contador ===== */
.grc-row{
  display: flex; gap: 8px; align-items: center; margin-top: 8px;
  flex-wrap: wrap;
}
.grc-row > *{ min-width: 0; }
.grc-spacer{ flex: 1 }
.grc-muted{ color: var(--muted); font-size: 12px }
.grc-msg{ margin: 8px 2px 0; font-size: 13px }

/* ===== Bot√≥n ===== */
.gb-cta{
  padding: 10px 14px;
  border: 0; border-radius: 12px; cursor: pointer;
  background: radial-gradient(140% 140% at 20% 20%, #68d7e1, #22bdc5 60%, #19868c 100%);
  color:#0a120a; font-weight:700;
  box-shadow: 0 6px 18px rgba(0, 237, 249, 0.763), inset 0 1px 2px rgba(255,255,255,.35);
}
.gb-cta:disabled{ filter: grayscale(.4) brightness(.85); cursor: not-allowed; opacity:.85 }

/* ===== Responsive ===== */
@media (max-width: 900px){
  .gb-review-card{ margin:16px auto; padding:14px; border-radius:16px }
  .grc-row{ gap:10px }
}
@media (max-width: 600px){
  .gb-review-card{ margin:14px 12px; padding:12px; border-radius:14px }
  .grc-sub{ flex-direction: column; align-items: flex-start; gap: 6px }
  .grc-meta{ margin-left: 0 }
  .grc-inp, .grc-ta{ padding:10px 12px }
  .grc-row{ flex-direction: column; align-items: stretch; gap: 8px }
  .gb-cta{ width: 100%; text-align: center }
}
@media (max-width: 360px){
  .gb-review-card{ padding:10px; border-radius:12px }
  .gb-review-card h3{ font-size:16px }
  .grc-sub{ font-size:12px }
}
@media (prefers-reduced-motion: reduce){
  .gb-review-card *{ transition: none !important; }
}

/* ===== Lluvia sugerida (aseg√∫rate de tener este contenedor FUERA de la card) ===== */
#lluvia-container{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;        /* por debajo del contenido */
}
body{ background: var(--bg); position: relative; }

</style>

<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, addDoc, collection, serverTimestamp }
    from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  // ===== NOMBRES √öNICOS PARA EVITAR COLISIONES =====
  const gbFirebaseConfig = {
    apiKey: "AIzaSyAJJgDg5SUPvvHgPtDNhIy1f1fiGpBHBw",
    authDomain: "registro-gomitas.firebaseapp.com",
    projectId: "registro-gomitas",
    storageBucket: "registro-gomitas.appspot.com",
    messagingSenderId: "435485731864",
    appId: "1:435485731864:web:43dff09753a4c9d507e76d"
  };

  const gbApp = getApps().length ? getApps()[0] : initializeApp(gbFirebaseConfig);
  const gbDb  = getFirestore(gbApp);

  // UI refs
  const $form = document.getElementById('grc-form');
  const $tel  = document.getElementById('grc-tel');
  const $txt  = document.getElementById('grc-txt');
  const $send = document.getElementById('grc-send');
  const $msg  = document.getElementById('grc-msg');
  const $count= document.getElementById('grc-count');

  // Helpers
  const onlyDigits = s => s.replace(/\D+/g,'');
  const isPhoneOk  = v => /^\d{8,15}$/.test(v);

  // Validaci√≥n en vivo
  $tel.addEventListener('input', ()=>{
    const clean = onlyDigits($tel.value);
    if (clean !== $tel.value) $tel.value = clean;
    toggleSubmit();
  });
  $txt.addEventListener('input', ()=>{
    $count.textContent = `${$txt.value.length}/600`;
    toggleSubmit();
  });
  function toggleSubmit(){
    const ok = isPhoneOk($tel.value) && $txt.value.trim().length >= 5;
    $send.disabled = !ok;
  }
  function resetMsg(){ $msg.textContent = ""; $msg.style.color = ""; }

  // Submit
  $form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if ($send.disabled) return;

    $send.disabled = true; resetMsg();

    const payload = {
      telefono: $tel.value.trim(),
      resena: $txt.value.trim(),
      createdAt: serverTimestamp(),
      estado: "pendiente"
    };

    try{
      await addDoc(collection(gbDb, "resenas"), payload);
      $msg.textContent = "¬°Gracias! Tu rese√±a fue registrada. Est√°s participando.";
      $msg.style.color = "var(--ok)";
      $form.reset(); $count.textContent = "0/600"; toggleSubmit();
    }catch(err){
      console.error(err);
      $msg.textContent = "No se pudo enviar. Intenta de nuevo.";
      $msg.style.color = "var(--err)";
    }finally{
      $send.disabled = false;
    }
  });
</script>




<!-- ================== MEGA JUEGO 7x7 (aislado con prefijo MG_) ================== -->
<section id="MG-juego" style="width:92%;max-width:960px;margin:24px auto;padding:12px;border-radius:18px;background:transparent;color:#eef3fb;font-family:'Poppins',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;box-sizing:border-box;overflow:visible;position:relative;z-index:0;">

  <style>
/* =================== MEGA 5x5 ‚Äî CSS limpio, centrado y responsive =================== */
:root { --MG-gap: 10px; }

#MG-juego{
  --W: min(680px, 94vw);         /* ancho maestro */
  --gap: var(--MG-gap);
  color:#e7ecf3;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  min-height:100vh; margin:0 auto; text-align:center; padding:10px 0 22px;
}

/* ---------- Header / Canvas ---------- */
#MG-head{
  position:relative; width:var(--W); margin:0 auto 10px; line-height:0; isolation:isolate; overflow:hidden;
}
#MG-title{
  display:block; width:100%; height:auto; border-radius:14px; box-shadow:0 12px 44px rgba(0,0,0,.35);
}
#MG-canvas{ position:absolute; inset:0; width:100%; height:22%; pointer-events:none; display:block; }

/* ---------- Tablero (5 columnas reales, centrado) ---------- */
#MG-board{
  width:var(--W);
  margin:4px auto 12px;                 /* centra horizontal */
  display:grid;
  grid-template-columns:repeat(5, minmax(0, 1fr));
  gap:var(--gap);
  align-items:stretch; justify-items:stretch;
  user-select:none;
}
#MG-board button{
  width:100%;
  aspect-ratio:1/1;                      /* cuadradas de verdad */
  display:grid; place-items:center;
  border-radius:14px; border:1px solid #2b3b58;
  background:
    radial-gradient(520px 260px at -10% -20%, rgba(56,189,248,.06), transparent 50%),
    radial-gradient(520px 260px at 110% 120%, rgba(147,51,234,.06), transparent 50%),
    linear-gradient(135deg,#0b0f18,#0f172a);
  color:#e7ecf3; font-weight:900; letter-spacing:.2px;
  font-size:clamp(12px, 2.2vw, 16px);
  cursor:pointer; transition:transform .18s ease,background .15s ease,border-color .15s ease,box-shadow .15s ease;
  transform-style:preserve-3d; padding:6px;
  box-shadow:0 0 0 1px rgba(40,54,82,.45), inset 0 0 24px rgba(255,255,255,.02);
  overflow:hidden;
}
#MG-board button:hover{ transform:translateY(-2px); box-shadow:0 10px 26px rgba(0,0,0,.35); }
#MG-board button:disabled{ opacity:.92; cursor:not-allowed; transform:none; box-shadow:none; }

.MG-cell-img{ width:86%; height:86%; object-fit:contain; display:block; pointer-events:none; transition:transform .15s ease; }
#MG-board button.MG-1500 .MG-cell-img{ transform:scale(1.16); }  /* reutilizado por $1000 */
#MG-board button.MG-500  .MG-cell-img{ transform:scale(1.12); }
#MG-board button.MG-200  .MG-cell-img{ transform:scale(1.10); }
#MG-board button.MG-50   .MG-cell-img{ transform:scale(1.08); }

/* Animaciones */
@keyframes MG-flip{0%{transform:rotateY(0)}50%{transform:rotateY(90deg)}100%{transform:rotateY(0)}}
@keyframes MG-shuffle{0%{transform:translate(0,0) rotate(0)}25%{transform:translate(1px,-1px) rotate(-1deg)}50%{transform:translate(-1px,1px) rotate(1deg)}75%{transform:translate(1px,1px) rotate(0)}100%{transform:translate(0,0) rotate(0)}}
.MG-is-flipping{ animation:MG-flip .5s both; }
.MG-is-shuffling{ animation:MG-shuffle .6s ease-in-out; }
@keyframes MG-pop{0%{transform:scale(.92)}100%{transform:scale(1)}}
.MG-pop{ animation:MG-pop .25s ease; }

/* ---------- Looks al revelar ---------- */
.MG-looks-1500{ background:linear-gradient(145deg,#064e3b,#0b6b52)!important; border-color:#18c38a!important; box-shadow:0 10px 36px rgba(14,159,110,.28); }
.MG-looks-500 { background:linear-gradient(145deg,#14532d,#1b7a3e)!important; border-color:#34d399!important; box-shadow:0 10px 34px rgba(16,185,129,.25); }
.MG-looks-200 { background:linear-gradient(145deg,#0b3a54,#0f5d8c)!important; border-color:#38bdf8!important; box-shadow:0 10px 34px rgba(56,189,248,.24); }

/* ===== $50 con look propio (plateado-azulado) ===== */
.MG-looks-50{
  background:
    radial-gradient(400px 220px at 20% 10%, rgba(226,232,240,.20), transparent 55%),
    linear-gradient(145deg,#334155,#1f2937) !important;   /* slate oscuro */
  border:2px solid #cbd5e1 !important;                    /* slate-200 */
  box-shadow:
    0 0 0 1px rgba(203,213,225,.35),
    0 10px 26px rgba(148,163,184,.28),
    inset 0 0 28px rgba(226,232,240,.10);
}
.MG-50{ animation:pulse50 1.35s infinite alternate; }
@keyframes pulse50{
  0%   { box-shadow:0 0 8px rgba(203,213,225,.55), inset 0 0 18px rgba(255,255,255,.06); }
  100% { box-shadow:0 0 18px rgba(226,232,240,.95), inset 0 0 26px rgba(255,255,255,.10); }
}

.MG-looks-gomita{
  background:linear-gradient(145deg,#3b0764,#5b0aa0)!important;
  border-color:#9b5cf7!important; box-shadow:0 10px 34px rgba(124,58,237,.25);
}
.MG-looks-nada{ background:linear-gradient(145deg,#191c24,#1b1f2a)!important; border-color:#2d3547!important; }

.MG-kicker{ font-size:12px; letter-spacing:.45px; text-transform:uppercase; color:#9fb0c9; text-align:center; margin:4px 0 8px; }

/* ---------- Tarjeta de c√≥digos ---------- */
#MG-card{
  width:var(--W);
  max-width:360px;
  margin:8px auto 0;
  padding:10px 12px;
  border-radius:12px;
  background:rgba(12,18,34,.70);
  border:1px solid #233046;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
  overflow:hidden;
  box-sizing:border-box;
}
#MG-card .MG-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; }
#MG-card .MG-inputs{ width:100%; display:flex; flex-direction:column; gap:8px; align-items:center; }
.MG-input-wrap{ position:relative; width:100%; max-width:320px; margin:0 auto; }
.MG-input{
  width:100%; height:38px;
  padding:6px 36px; border-radius:10px; border:1px solid #2f3c55;
  background:#0f172a; color:#e7ecf3; outline:none;
  font-weight:800; letter-spacing:.8px; text-align:center; font-size:13px; box-sizing:border-box;
}
.MG-label{ position:absolute; left:10px; top:50%; transform:translateY(-50%); font-size:11px; color:#8aa0c0; pointer-events:none; }
.MG-icon{ position:absolute; right:10px; top:50%; transform:translateY(-50%); width:16px; height:16px; opacity:.7; pointer-events:none; }

#MG-validar{
  width:100%; height:38px; margin:6px 0 0; border-radius:10px;
  border:1px solid #2b3750;
  background:linear-gradient(135deg,#6d28d9,#2563eb);
  color:#fff; font-weight:900; letter-spacing:.2px; cursor:pointer;
  box-shadow:0 4px 12px rgba(37,99,235,.22);
}
#MG-validar:hover{ transform:translateY(-1px); }

#MG-status{ font-size:12px; opacity:.92; margin-top:6px; text-align:center; }

/* ---------- Modal ---------- */
#MG-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(4,6,12,.58); backdrop-filter:blur(1.5px); z-index:100000; }
#MG-card-modal{
  width:min(300px,92vw);
  border:1px solid #2b3750; border-radius:16px;
  box-shadow:0 18px 60px rgba(0,0,0,.45); padding:18px;
  background:
    radial-gradient(520px 220px at 20% 0%,rgba(99,102,241,.12),transparent 60%),
    radial-gradient(520px 220px at 80% 100%,rgba(34,197,94,.12),transparent 60%),
    #0b1220;
}
#MG-card-modal.success{ border-color:#16a34a; background:radial-gradient(520px 220px at 20% 0%,rgba(34,197,94,.12),transparent 60%),#071c12; }
#MG-card-modal.warn{    border-color:#7c3aed; background:radial-gradient(520px 220px at 20% 0%,rgba(124,58,237,.14),transparent 60%),#13072b; }
#MG-card-modal.neutral{ border-color:#475569; background:radial-gradient(520px 220px at 20% 0%,rgba(100,116,139,.10),transparent 60%),#0b1220; }
#MG-figure{ display:flex; align-items:center; justify-content:center; margin:6px 0 10px; }
#MG-figure img{ width:min(190px,56%); height:auto; filter:drop-shadow(0 10px 28px rgba(0,0,0,.35)); }
.MG-headline{ display:block; text-align:center; line-height:1.1; margin:0 0 6px; letter-spacing:.2px; font-weight:900; }
.MG-headline .xl{ display:inline-block; font-size:clamp(26px,5.6vw,36px); }
.MG-headline .md{ display:inline-block; font-size:clamp(17px,3.4vw,21px); font-weight:800; opacity:.95; }
.MG-accent{ background:linear-gradient(90deg,#22c55e,#86efac); -webkit-background-clip:text; background-clip:text; color:transparent; }
.MG-accent-purple{ background:linear-gradient(90deg,#a78bfa,#22d3ee); -webkit-background-clip:text; background-clip:text; color:transparent; }
#MG-actions{ display:flex; justify-content:center; gap:8px; margin-top:6px; flex-wrap:wrap; }
.MG-cta{ display:inline-flex; gap:8px; align-items:center; border-radius:999px; padding:8px 14px; border:1px solid #2b3750; background:#121c2e; color:#e7ecf3; font-weight:800; }
#MG-ok{ padding:8px 14px; border-radius:12px; border:1px solid #1f2937; background:#1f6feb; color:#fff; cursor:pointer; font-weight:900; min-width:110px; text-align:center; }

/* ---------- Mobile ---------- */
@media (max-width:560px){
  #MG-juego{ --W: 92vw; --gap: 8px; }
  #MG-board{ gap:var(--gap)!important; }
  #MG-board button{ border-radius:12px!important; }
  #MG-card{ width:var(--W); max-width:none; }
  #MG-validar{ height:40px; }
}

/* ---------- Tablet ---------- */
@media (min-width:600px) and (max-width:1024px){
  #MG-juego{ --W: min(640px, 92vw); --gap: 10px; }
  #MG-head{ width:var(--W); margin:0 auto 12px; }
  #MG-canvas{ height:24%; }
  #MG-board{ width:var(--W); gap:var(--gap); }
  #MG-board button{
    padding:8px; border-radius:14px;
    font-size:clamp(13px, 1.8vw, 18px);
  }
  .MG-kicker{ font-size:13px; }
  #MG-card{
    width:var(--W);
    max-width:520px;
    padding:14px 16px; border-radius:14px;
  }
  .MG-input-wrap{ max-width:480px; }
  .MG-input{ height:44px; font-size:14px; letter-spacing:.7px; padding:8px 36px; border-radius:12px; }
  .MG-label{ left:12px; font-size:12px; }
  #MG-validar{ width:100%; height:46px; border-radius:12px; margin-top:8px; }
  #MG-card-modal{ width:min(520px, 88vw); padding:22px; border-radius:18px; }
  #MG-figure img{ width:min(240px, 48%); }
  .MG-headline .xl{ font-size:clamp(28px, 4.2vw, 34px); }
  .MG-headline .md{ font-size:clamp(18px, 2.6vw, 22px); }
  #MG-actions{ gap:10px; }
  #MG-ok{ min-width:128px; padding:10px 16px; }
}
</style>

<center>
  <div id="MG-head">
    <img id="MG-title" src="img/gan201.png" alt="Mega T√≠tulo">
    <canvas id="MG-canvas"></canvas>
  </div>

  <p class="MG-kicker">Te GARANTIZAMOS un premio con 5 tiros</p>

  <div id="MG-board"></div>

    <div class="MG-row MG-inputs">
      <div class="MG-input-wrap">
        <span class="MG-label">C√≥digo #1</span>
        <input id="MG-code1" class="MG-input" type="text" placeholder="SUERTE!! :)">
        <svg class="MG-icon" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="#9fb0c9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="MG-input-wrap">
        <span class="MG-label">C√≥digo #2</span>
        <input id="MG-code2" class="MG-input" type="text" placeholder="LO DE ARRIBA X2">
        <svg class="MG-icon" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="#9fb0c9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
    </div>
    <center>
    <div class="MG-row MG-actions"><button id="MG-validar">Validar y jugar</button></div>
    <div id="MG-status"></div>
  </div>
</section>

<!-- ==== MODALES FUERA DEL SECTION para evitar recortes por overflow/filters ==== -->
<div id="MG-modal" role="dialog" aria-modal="true">
  <div id="MG-card-modal" class="neutral">
    <div id="MG-figure" aria-hidden="true"></div>
    <h3 id="MG-title-modal" style="margin:0"></h3>
    <p id="MG-msg" style="margin:0"></p>
    <div id="MG-actions">
      <a id="MG-cta" class="MG-cta" href="https://www.instagram.com/gummybank?igsh=MW82Z3hvN2VjbWYxZw%3D%3D&utm_source=qr" target="_blank" rel="noopener noreferrer" style="display:none">Abrir Instagram</a>
      <button id="MG-ok">Cerrar</button>
    </div>
  </div>
</div>

<div id="MG-phone" role="dialog" aria-modal="true" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(1px);z-index:100001">
  <div class="MG-phone-card" style="width:min(340px,92vw);background:#0b1220;border:1px solid #334155;border-radius:14px;box-shadow:0 16px 50px rgba(0,0,0,.42);padding:12px">
    <h3 class="MG-phone-title" style="margin:0 0 4px;font-size:18px;text-align:center">Confirma tu tel√©fono</h3>
    <p class="MG-phone-sub" style="margin:0 0 10px;opacity:.9;text-align:center;font-size:14px">Para registrar tu participaci√≥n, ingresa tu n√∫mero.</p>
    <div class="MG-phone-row" style="display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap">
      <input id="MG-phone-input" class="MG-phone-input" inputmode="tel" autocomplete="tel" maxlength="15" placeholder="8 a 15 d√≠gitos"
             style="flex:1;min-width:180px;max-width:220px;height:40px;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#eee;outline:none;text-align:center;font-weight:700;letter-spacing:.8px">
      <button id="MG-phone-ok" class="MG-phone-btn" style="height:40px;padding:10px 12px;border-radius:10px;border:1px solid #1f2937;background:#1f6feb;color:#fff;cursor:pointer;font-weight:800;min-width:110px">Continuar</button>
      <button id="MG-phone-cancel" class="MG-phone-btn secondary" style="height:40px;padding:10px 12px;border-radius:10px;border:1px solid #475569;background:#1f2937;color:#e5e7eb;min-width:110px">Cancelar</button>
    </div>
    <div id="MG-phone-error" class="MG-phone-err" style="min-height:18px;margin-top:6px;font-size:12px;color:#fca5a5;text-align:center"></div>
  </div>
</div>

<script type="module">
/* ========= MEGA 5x5 - L√ìGICA (solo JS, dise√±o intacto) ========= */
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection,
  runTransaction, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

/* ---------------- Config Firebase ---------------- */
const MG_IG_URL = (window.IG_URL || "https://instagram.com/tu_pagina");
const MG_firebaseConfig = window.firebaseConfig || {
  apiKey: "AIzaSyAJJgDg5SUPvvHgPtDNhIy1f1fiGpBHBw",
  authDomain: "registro-gomitas.firebaseapp.com",
  projectId: "registro-gomitas",
  storageBucket: "registro-gomitas.appspot.com",
  messagingSenderId: "435485731864",
  appId: "1:435485731864:web:43dff09753a4c9d507e76d",
  measurementId: "G-20KEW71X9G"
};
const MG_app = getApps().length ? getApp() : initializeApp(MG_firebaseConfig);
const MG_db  = getFirestore(MG_app);

/* ---------------- Par√°metros del juego ----------------
   Si cambias el tama√±o del tablero:
   - MG_TOTAL = n√∫mero de casillas
   - En CSS: #MG-board -> grid-template-columns:repeat(N,...)
------------------------------------------------------- */
const MG_TOTAL = 25; // 5x5
const MG_COUNTS = { p1000: 1, p500: 1, p200: 2, p50: 4, gomita: 9 };
/* Umbrales: los NUEVOS aparecen despu√©s de 100 tiros:
   - p1000 y p50 son nuevos -> 100
   Los existentes se quedan igual que estaban. */
const MG_THRESH = { p1000: 100000, p500: 100000, p200: 10000, p50: 5, gomita: 3 };

/* ----------------- Referencias en DB ----------------- */
const MG_controlRef = doc(MG_db, "mega7x7_meta", "control"); // contadores globales
const MG_playsCol   = collection(MG_db, "mega7x7_plays");    // jugadas

/* ---------------- Utilidades ---------------- */
const MG_toId = s => (s||"").trim().toUpperCase().replace(/[^A-Z0-9]/g,"");
const MG_svg  = s => 'data:image/svg+xml;utf8,' + encodeURIComponent(s.trim());
const MG_IMG = {
  HIDDEN: MG_svg(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect width="120" height="120" rx="18" fill="#111827"/><text x="50%" y="56%" text-anchor="middle" dominant-baseline="middle" font-family="system-ui,Segoe UI,Roboto" font-size="68" fill="#9fb0c9">?</text></svg>`),
  NADA  : MG_svg(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect width="120" height="120" rx="18" fill="#1b2332"/><path d="M30 30 L90 90 M90 30 L30 90" stroke="#d1d5db" stroke-width="14" stroke-linecap="round"/></svg>`),
  GOMITA: "img/gomita.png",
  P200  : MG_svg(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect width="120" height="120" rx="18" fill="#0b3a54"/><circle cx="60" cy="60" r="38" fill="#0ea5e9"/><text x="50%" y="56%" text-anchor="middle" dominant-baseline="middle" font-family="system-ui,Segoe UI,Roboto" font-size="42" fill="#e6fffa">$200</text></svg>`),
  P500  : MG_svg(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect width="120" height="120" rx="18" fill="#14532d"/><circle cx="60" cy="60" r="40" fill="#22c55e"/><text x="50%" y="56%" text-anchor="middle" dominant-baseline="middle" font-family="system-ui,Segoe UI,Roboto" font-size="44" fill="#e6fffa">$500</text></svg>`),
  P1000 : MG_svg(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect width="120" height="120" rx="18" fill="#064e3b"/><circle cx="60" cy="60" r="40" fill="#0e9f6e"/><text x="50%" y="56%" text-anchor="middle" dominant-baseline="middle" font-family="system-ui,Segoe UI,Roboto" font-size="40" fill="#e6fffa">$1000</text></svg>`),
  P50   : MG_svg(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect width="120" height="120" rx="18" fill="#1e293b"/><circle cx="60" cy="60" r="36" fill="#94a3b8"/><text x="50%" y="56%" text-anchor="middle" dominant-baseline="middle" font-family="system-ui,Segoe UI,Roboto" font-size="46" fill="#0b1220">$50</text></svg>`)
};
/* ‚Üê IMPORTANTE: ahora manejamos 'HIDDEN' para que muestre el '?' */
const MG_icon = (k) => {
  switch (k) {
    case 'HIDDEN': return MG_IMG.HIDDEN;
    case 'p1000' : return MG_IMG.P1000;
    case 'p500'  : return MG_IMG.P500;
    case 'p200'  : return MG_IMG.P200;
    case 'p50'   : return MG_IMG.P50;
    case 'gomita': return MG_IMG.GOMITA;
    default      : return MG_IMG.NADA;
  }
};

/* ---------------- DOM ---------------- */
const MG_board = document.getElementById("MG-board");
const MG_status= document.getElementById("MG-status");
const MG_code1 = document.getElementById("MG-code1");
const MG_code2 = document.getElementById("MG-code2");
const MG_goBtn = document.getElementById("MG-validar");

const MG_modal = document.getElementById("MG-modal");
const MG_cardM = document.getElementById("MG-card-modal");
const MG_tModal= document.getElementById("MG-title-modal");
const MG_msg   = document.getElementById("MG-msg");
const MG_cta   = document.getElementById("MG-cta");
const MG_ok    = document.getElementById("MG-ok");
const MG_figure= document.getElementById("MG-figure");

const MG_pModal= document.getElementById("MG-phone");
const MG_pIn   = document.getElementById("MG-phone-input");
const MG_pOk   = document.getElementById("MG-phone-ok");
const MG_pCancel=document.getElementById("MG-phone-cancel");
const MG_pErr  = document.getElementById("MG-phone-error");
const MG_canvas= document.getElementById("MG-canvas");

/* ---------------- Estado ---------------- */
let MG_ready=false, MG_codes=null, MG_tel=null, MG_picked=false;

/* ---------------- Helpers UI ---------------- */
function MG_setIcon(btn, kind){
  let alt = 'Sin premio';
  if (kind === 'HIDDEN') alt = 'Oculto';
  else if (kind === 'p1000') alt = '$1000';
  else if (kind === 'p500')  alt = '$500';
  else if (kind === 'p200')  alt = '$200';
  else if (kind === 'p50')   alt = '$50';
  else if (kind === 'gomita')alt = 'Gomitas';

  btn.innerHTML = `<img class="MG-cell-img" alt="${alt}" src="${MG_icon(kind)}">`;
  btn.setAttribute('aria-label', alt);
}
function MG_setLooks(btn, kind){
  btn.classList.remove('MG-looks-1500','MG-looks-500','MG-looks-200','MG-looks-gomita','MG-looks-nada','MG-1500','MG-500','MG-200');
  if(kind==='p1000') btn.classList.add('MG-looks-1500','MG-1500'); // reutiliza estilos del antiguo 1500
  else if(kind==='p500') btn.classList.add('MG-looks-500','MG-500');
  else if(kind==='p200' || kind==='p50') btn.classList.add('MG-looks-200','MG-200'); // 50 hereda look de 200
  else if(kind==='gomita') btn.classList.add('MG-looks-gomita');
  else btn.classList.add('MG-looks-nada');
}
function MG_paint(msg,color){ MG_status.textContent=msg; MG_status.style.color=color||"#9fb0c9"; }

/* badges opcionales, si no existen no hace nada */
function MG_badges(ok1, ok2){
  const b1 = document.getElementById('MG-b1');
  const b2 = document.getElementById('MG-b2');
  if (!b1 || !b2) return;
  b1.classList.remove('ok','err'); b2.classList.remove('ok','err');
  if (ok1 !== undefined) b1.classList.add(ok1 ? 'ok' : 'err');
  if (ok2 !== undefined) b2.classList.add(ok2 ? 'ok' : 'err');
  b1.textContent = ok1 ? 'C√≥digo #1 ‚úì' : 'C√≥digo #1';
  b2.textContent = ok2 ? 'C√≥digo #2 ‚úì' : 'C√≥digo #2';
}

/* ---------------- Vitrina inicial ---------------- */
MG_makeVitrine();
function MG_makeVitrine(){
  const pool=['p1000','p500'];
  for(let i=0;i<MG_COUNTS.p200;i++)   pool.push('p200');
  for(let i=0;i<MG_COUNTS.p50;i++)    pool.push('p50');
  for(let i=0;i<MG_COUNTS.gomita;i++) pool.push('gomita');
  for(let i=pool.length;i<MG_TOTAL;i++) pool.push('nada');
  for(let i=pool.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [pool[i],pool[j]]=[pool[j],pool[i]]; }
  MG_board.innerHTML='';
  pool.forEach(k=>{ const b=document.createElement('button'); MG_setIcon(b,k); MG_setLooks(b,k); b.disabled=true; MG_board.appendChild(b); });
  MG_paint("Necesitas 2 c√≥digos v√°lidos para jugar.", "#9fb0c9");
}

/* ---------------- Click ‚ÄúValidar y jugar‚Äù ---------------- */
MG_goBtn.addEventListener("click", async ()=>{
  const c1 = MG_toId(MG_code1.value), c2 = MG_toId(MG_code2.value);
  if(!c1 || !c2){ MG_paint("Ingresa los 2 c√≥digos.","#ff6b6b"); MG_lock(); return; }
  if(c1===c2){ MG_paint("Los c√≥digos deben ser distintos.","#ff6b6b"); MG_lock(); return; }

  try{
    const ok1 = await MG_checkCode(c1);
    const ok2 = await MG_checkCode(c2);
    if(!ok1 || !ok2){ MG_badges(false,false); MG_paint("C√≥digo inv√°lido o ya usado.","#ff6b6b"); MG_lock(); return; }
    MG_badges(true,true);

    try{ MG_tel = await MG_phoneAsk(); }
    catch(_){ MG_paint("Participaci√≥n cancelada.","#fca5a5"); return; }

    MG_codes = { c1, c2 };
    MG_paint("Tienes 1 intento. Mezclando...","#3fb950");
    await MG_flipShuffle();
  }catch(e){ console.error(e); MG_paint("Error al validar.","#ff6b6b"); }
});

/* ---------------- Preparar tablero real ---------------- */
function MG_lock(){ [...MG_board.children].forEach(b=>b.disabled=true); MG_ready=false; }
function MG_unlock(){ [...MG_board.children].forEach(b=>b.disabled=false); MG_ready=true; }

async function MG_flipShuffle(){
  const bs=[...MG_board.children];
  await Promise.all(bs.map((b,i)=>new Promise(res=>{
    setTimeout(()=>{
      MG_setIcon(b,'HIDDEN'); // ‚Üê muestra "?"
      b.classList.remove('MG-looks-1500','MG-looks-500','MG-looks-200','MG-looks-gomita','MG-looks-nada','MG-1500','MG-500','MG-200');
      b.style.background="linear-gradient(135deg,#0b0f18,#0f172a)"; b.style.borderColor="#2b3b58";
      res();
    }, i*20);
  })));
  await MG_realPool();
  bs.forEach((b,i)=>{ setTimeout(()=>{ b.classList.add("MG-is-shuffling"); setTimeout(()=>b.classList.remove("MG-is-shuffling"),650); }, i*10); });
  MG_unlock(); MG_ready=true; MG_picked=false;
  MG_paint("C√≥digos validados. Elige una casilla.","#3fb950");
}

/* ---------------- Control en Firestore ---------------- */
async function MG_getControl(){                             // Funci√≥n as√≠ncrona que garantiza y lee el documento de control global.

 /* ---------------- Control en Firestore (safe init) ---------------- */
async function MG_getControl(){
  // 1) Leer primero
  const snap = await getDoc(MG_controlRef);

  // 2) Si NO existe, inicializa una sola vez
  if (!snap.exists()) {
    await setDoc(MG_controlRef, {
      since1000: 0, since500: 0, since200: 0, since50: 0, sinceGomita: 0,
      wins1000: 0,  wins500: 0,  wins200: 0,  wins50: 0,  winsGomita: 0,
      totalPlays: 0,
      updatedAt: serverTimestamp()
    });
    return {
      since1000:0, since500:0, since200:0, since50:0, sinceGomita:0,
      wins1000:0, wins500:0, wins200:0, wins50:0, winsGomita:0,
      totalPlays:0
    };
  }

  // 3) Si S√ç existe, NO resetees. Solo normaliza y, si faltara algo, compl√©talo sin pisar valores.
  const d = snap.data() || {};
  const patch = {};
  if (d.since1000 == null)  patch.since1000 = 0;
  if (d.since500  == null)  patch.since500  = 0;
  if (d.since200  == null)  patch.since200  = 0;
  if (d.since50   == null)  patch.since50   = 0;
  if (d.sinceGomita == null)patch.sinceGomita = 0;

  if (d.wins1000  == null)  patch.wins1000  = 0;
  if (d.wins500   == null)  patch.wins500   = 0;
  if (d.wins200   == null)  patch.wins200   = 0;
  if (d.wins50    == null)  patch.wins50    = 0;
  if (d.winsGomita== null)  patch.winsGomita= 0;

  if (d.totalPlays== null)  patch.totalPlays= 0;

  // Escribe SOLO lo faltante y el updatedAt
  await setDoc(MG_controlRef, { ...patch, updatedAt: serverTimestamp() }, { merge:true });

  // 4) Devuelve contadores normalizados (n√∫meros)
  return {
    since1000:+(d.since1000 ?? 0),
    since500:+(d.since500 ?? 0),
    since200:+(d.since200 ?? 0),
    since50:+(d.since50 ?? 0),
    sinceGomita:+(d.sinceGomita ?? 0),
    wins1000:+(d.wins1000 ?? 0),
    wins500:+(d.wins500 ?? 0),
    wins200:+(d.wins200 ?? 0),
    wins50:+(d.wins50 ?? 0),
    winsGomita:+(d.winsGomita ?? 0),
    totalPlays:+(d.totalPlays ?? 0)
  };
}                                    // merge:true asegura que solo completa campos faltantes y no borra existentes.

  const s = await getDoc(MG_controlRef);                    // Lee el snapshot actual del documento de control.
  const d = s.exists() ? (s.data() || {}) : {};             // Si existe, extrae sus datos; si no, usa objeto vac√≠o para evitar undefined.

  return {                                                  // Devuelve un objeto ‚Äúnormalizado‚Äù solo con n√∫meros (usa + para convertir).
    since1000:+(d.since1000||0),                            // Asegura n√∫mero: si la propiedad no existe, usa 0.
    since500:+(d.since500||0),
    since200:+(d.since200||0),
    since50:+(d.since50||0),
    sinceGomita:+(d.sinceGomita||0),

    wins1000:+(d.wins1000||0),                              // Totales de premios otorgados, tambi√©n normalizados.
    wins500:+(d.wins500||0),
    wins200:+(d.wins200||0),
    wins50:+(d.wins50||0),
    winsGomita:+(d.winsGomita||0),

    totalPlays:+(d.totalPlays||0)                           // Total de jugadas registradas.
  };
}

async function MG_realPool(){                               // Construye el ‚Äúpool‚Äù de premios real para este tablero.
  const c = await MG_getControl();                          // Obtiene contadores/estad√≠sticas actuales desde Firestore.

  const en = {                                              // Flags de habilitaci√≥n por umbral (true si ya se alcanz√≥ el m√≠nimo).
    p1000 : c.since1000  >= MG_THRESH.p1000,                // Habilita $1000 si los tiros desde el √∫ltimo >= umbral.
    p500  : c.since500   >= MG_THRESH.p500,                 // Habilita $500 seg√∫n su umbral.
    p200  : c.since200   >= MG_THRESH.p200,                 // Habilita $200 seg√∫n su umbral.
    p50   : c.since50    >= MG_THRESH.p50,                  // Habilita $50 seg√∫n su umbral.
    gomita: c.sinceGomita>= MG_THRESH.gomita                // Habilita gomitas seg√∫n su umbral.
  };

  const pool=[];                                            // Arreglo final con el contenido de cada casilla (tama√±o = MG_TOTAL).

  if(en.p1000) pool.push('p1000');                          // Inserta 1 premio $1000 si est√° habilitado.
  if(en.p500)  pool.push('p500');                           // Inserta 1 premio $500 si est√° habilitado.

  for(let i=0;i<(en.p200?MG_COUNTS.p200:0);i++)             // Inserta N premios $200 si est√°n habilitados‚Ä¶
    pool.push('p200');                                      // ‚Ä¶N proviene de MG_COUNTS.p200.

  for(let i=0;i<(en.p50?MG_COUNTS.p50:0);i++)               // Inserta N premios $50 si est√°n habilitados‚Ä¶
    pool.push('p50');                                       // ‚Ä¶N proviene de MG_COUNTS.p50.

  for(let i=0;i<(en.gomita?MG_COUNTS.gomita:0);i++)         // Inserta N ‚Äúgomita‚Äù si est√°n habilitadas‚Ä¶
    pool.push('gomita');                                    // ‚Ä¶N proviene de MG_COUNTS.gomita.

  for(let i=pool.length;i<MG_TOTAL;i++) pool.push('nada');  // Completa hasta MG_TOTAL con ‚Äúnada‚Äù para llenar el tablero.

  for(let i=pool.length-1;i>0;i--){                         // Barajado Fisher‚ÄìYates para distribuir premios aleatoriamente.
    const j=(Math.random()*(i+1))|0;                        // √çndice aleatorio entero entre 0 e i.
    [pool[i],pool[j]]=[pool[j],pool[i]];                    // Intercambia posiciones i y j.
  }

  [...MG_board.children].forEach((b,idx)=>{                 // Asigna el contenido a cada bot√≥n/casilla del tablero.
    b.dataset.MGprize = pool[idx];                          // Guarda el premio real en data-attribute (para usar al revelar).
    MG_setIcon(b,'HIDDEN');                                 // Muestra el √≠cono de ‚Äúoculto‚Äù (el signo ?), no el premio real.
    b.disabled=false;                                       // Habilita la casilla para que pueda clicarse.
    b.onclick=()=>MG_onPick(b);                             // Asocia el handler de click que gestiona la selecci√≥n.
    b.style.background="linear-gradient(135deg,#0b0f18,#0f172a)"; // Resetea background base visual.
    b.style.borderColor="#2b3b58";                          // Resetea color de borde base.
  });

  MG_board.dataset.fake1000  = String(!en.p1000);           // Flags para el ‚Äúreveal‚Äù visual: si NO estaba habilitado‚Ä¶
  MG_board.dataset.fake500   = String(!en.p500);            // ‚Ä¶queda ‚Äútrue‚Äù y el reveal puede mostrar premios ‚Äúfalsos‚Äù
  MG_board.dataset.fake200   = String(!en.p200);            // ‚Ä¶solo de forma visual para completar la vitrina objetivo.
  MG_board.dataset.fake50    = String(!en.p50);             // Estas flags no afectan el resultado final, solo la animaci√≥n.
  MG_board.dataset.fakeGomita= String(!en.gomita);
}                                                           // Fin de MG_realPool


/* ---------------- Click en casilla ---------------- */
async function MG_onPick(btn){
  if(!MG_ready || !MG_codes || MG_picked) return;
  MG_picked=true; MG_lock();

  const cand = btn.dataset.MGprize;
  await MG_reveal(btn, cand);

  try{
    await MG_persist(MG_codes.c1, MG_codes.c2, MG_tel, cand);
  }catch(e){
    console.error(e);
    MG_paint("No se pudo registrar la jugada.","#fca5a5");
  }

  await MG_revealRest(btn);

  if(cand==='p1000'){ MG_confetti('gold');  MG_open('success','p1000'); }
  else if(cand==='p500'){ MG_confetti('gold'); MG_open('success','p500'); }
  else if(cand==='p200'){ MG_confetti('gold'); MG_open('success','p200'); }
  else if(cand==='p50'){ MG_confetti('gold'); MG_open('success','p50'); }
  else if(cand==='gomita'){ MG_confetti('purple'); MG_open('warn','gomita'); }
  else MG_open('neutral','nada');
}

function MG_reveal(btn,kind){
  return new Promise(res=>{
    btn.classList.add('MG-is-flipping');
    setTimeout(()=>{
      MG_setIcon(btn,kind); MG_setLooks(btn,kind);
      btn.classList.remove('MG-is-flipping'); btn.classList.add('MG-pop');
      setTimeout(()=>{ btn.classList.remove('MG-pop'); res(); },160);
    },160);
  });
}

/* Revelado del resto: asegura 1√ó$1000, 1√ó$500, 2√ó$200, 3√ó$50 y 7√ógomita cuando no est√©n habilitados */
function MG_revealRest(chosen){
  const bs=[...MG_board.children];
  const avail = bs.filter(b => b !== chosen);

  const countReal = k => bs.filter(b => b.dataset.MGprize === k).length;
  const take = (n) => { const out=[]; for(let i=0;i<n && avail.length;i++){ const j=(Math.random()*avail.length)|0; out.push(avail.splice(j,1)[0]); } return out; };

  const fakes = [];
  if (MG_board.dataset.fake1000 === "true" && countReal('p1000') === 0) fakes.push({k:'p1000', bs: take(1)});
  if (MG_board.dataset.fake500  === "true" && countReal('p500')  === 0) fakes.push({k:'p500',  bs: take(1)});

  if (MG_board.dataset.fake200  === "true"){
    const need200 = Math.max(0, MG_COUNTS.p200 - countReal('p200'));
    if (need200 > 0) fakes.push({k:'p200',  bs: take(need200)});
  }
  if (MG_board.dataset.fake50 === "true"){
    const need50 = Math.max(0, MG_COUNTS.p50 - countReal('p50'));
    if (need50 > 0) fakes.push({k:'p50',  bs: take(need50)});
  }
  if (MG_board.dataset.fakeGomita === "true"){
    const needG = Math.max(0, MG_COUNTS.gomita - countReal('gomita'));
    if (needG > 0) fakes.push({k:'gomita', bs: take(needG)});
  }

  let t=110;
  const ps=[];
  for(const b of bs){
    if(b===chosen) continue;
    ps.push(new Promise(r=>{
      setTimeout(()=>{
        const fk = fakes.find(x => x.bs.includes(b));
        if (fk){ MG_setIcon(b,fk.k); MG_setLooks(b,fk.k); }
        else { const k=b.dataset.MGprize; MG_setIcon(b,k); MG_setLooks(b,k); }
        r();
      }, t);
      t += 45;
    }));
  }
  return Promise.all(ps);
}

/* ---------------- Validaci√≥n de c√≥digos ---------------- */
async function MG_checkCode(codeRaw){
  const code = MG_toId(codeRaw);
  const ref  = doc(MG_db,"codigos",code);
  const s    = await getDoc(ref);
  if(!s.exists()) return false;
  const d = s.data()||{};
  if((d.estado||"").toLowerCase()==="usado") return false;
  return true;
}

/* ---------------- Persistencia + contadores ---------------- */
async function MG_persist(c1,c2,phone,rawPrize){
  const r1   = doc(MG_db,"codigos",MG_toId(c1));
  const r2   = doc(MG_db,"codigos",MG_toId(c2));
  const play = doc(MG_playsCol);

  const cascade=(cand,elig)=>{
    switch(cand){
      case 'p1000': return elig.p1000 ? 'p1000' : elig.p500 ? 'p500' : elig.p200 ? 'p200' : elig.p50 ? 'p50' : elig.gomita ? 'gomita' : 'nada';
      case 'p500' : return elig.p500  ? 'p500'  : elig.p200 ? 'p200' : elig.p50 ? 'p50' : elig.gomita ? 'gomita' : 'nada';
      case 'p200' : return elig.p200  ? 'p200'  : elig.p50 ? 'p50' : elig.gomita ? 'gomita' : 'nada';
      case 'p50'  : return elig.p50   ? 'p50'   : elig.gomita ? 'gomita' : 'nada';
      case 'gomita':return elig.gomita? 'gomita': 'nada';
      default:      return 'nada';
    }
  };

  await runTransaction(MG_db, async (tx)=>{
    const cSnap = await tx.get(MG_controlRef);
    const cData = cSnap.exists() ? (cSnap.data()||{}) : {
      since1000:0, since500:0, since200:0, since50:0, sinceGomita:0,
      wins1000:0, wins500:0, wins200:0, wins50:0, winsGomita:0, totalPlays:0
    };

    const s1 = await tx.get(r1), s2 = await tx.get(r2);
    if(!s1.exists() || !s2.exists()) throw new Error("C√≥digo no existe");
    const d1=s1.data()||{}, d2=s2.data()||{};
    if((d1.estado||"").toLowerCase()==="usado" || (d2.estado||"").toLowerCase()==="usado")
      throw new Error("C√≥digo ya usado");

    const elig = {
      p1000:+(cData.since1000||0)>=MG_THRESH.p1000,
      p500 :+(cData.since500 ||0)>=MG_THRESH.p500,
      p200 :+(cData.since200 ||0)>=MG_THRESH.p200,
      p50  :+(cData.since50  ||0)>=MG_THRESH.p50,
      gomita:+(cData.sinceGomita||0)>=MG_THRESH.gomita
    };

    const final = cascade(rawPrize, elig);

    tx.set(play,{
      codigo1:MG_toId(c1), codigo2:MG_toId(c2), telefono:phone,
      rawPrize, finalPrize:final, createdAt:serverTimestamp()
    });

    tx.set(r1,{ estado:"usado", usadoEn:"MegaJuego5x5", usadoAt:serverTimestamp(), telefono:phone, resultado:final },{ merge:true });
    tx.set(r2,{ estado:"usado", usadoEn:"MegaJuego5x5", usadoAt:serverTimestamp(), telefono:phone, resultado:final },{ merge:true });

    const next = {
      since1000:   final==='p1000' ? 0 : +(cData.since1000||0)+1,
      since500 :   final==='p500'  ? 0 : +(cData.since500 ||0)+1,
      since200 :   final==='p200'  ? 0 : +(cData.since200 ||0)+1,
      since50  :   final==='p50'   ? 0 : +(cData.since50  ||0)+1,
      sinceGomita: final==='gomita'? 0 : +(cData.sinceGomita||0)+1,

      wins1000:   (cData.wins1000  ||0) + (final==='p1000'?1:0),
      wins500 :   (cData.wins500   ||0) + (final==='p500' ?1:0),
      wins200 :   (cData.wins200   ||0) + (final==='p200' ?1:0),
      wins50  :   (cData.wins50    ||0) + (final==='p50'  ?1:0),
      winsGomita: (cData.winsGomita||0) + (final==='gomita'?1:0),

      totalPlays: (cData.totalPlays||0) + 1,
      updatedAt: serverTimestamp()
    };

    tx.set(MG_controlRef, next, { merge:true });
  });
}

/* ---------------- Modal resultado ---------------- */
function MG_open(variant,kind){
  MG_figure.innerHTML=""; MG_cardM.classList.remove('success','warn','neutral'); if(variant) MG_cardM.classList.add(variant);
  const im=document.createElement('img'); im.src=MG_icon(kind); im.alt=kind; MG_figure.appendChild(im);

  if(kind==='p1000'){
    MG_tModal.innerHTML=`<div class="MG-headline"><span class="md">¬°PREMIO MAYOR!</span><br><span class="xl MG-accent">$1000</span></div>`;
    MG_msg.innerHTML = `<div style="text-align:center"><span style="color:#fde68a;font-weight:800">TOMA CAPTURA DE PANTALLA</span><br><span>Env√≠ala por DM en Instagram.</span></div>`;
    MG_cta.style.display='inline-flex'; MG_cta.href=MG_IG_URL; MG_cta.textContent='Abrir Instagram';
  } else if(kind==='p500'){
    MG_tModal.innerHTML=`<div class="MG-headline"><span class="md">¬°GANASTE</span> <span class="md MG-accent">$500!</span></div>`;
    MG_msg.innerHTML = `<div style="text-align:center"><span style="color:#fde68a;font-weight:800">TOMA CAPTURA DE PANTALLA</span><br><span>DM para reclamar.</span></div>`;
    MG_cta.style.display='inline-flex'; MG_cta.href=MG_IG_URL;
  } else if(kind==='p200'){
    MG_tModal.innerHTML=`<div class="MG-headline"><span class="md">¬°GANASTE</span> <span class="md MG-accent">$200!</span></div>`;
    MG_msg.innerHTML = `<div style="text-align:center"><span style="color:#fde68a;font-weight:800">TOMA CAPTURA DE PANTALLA</span><br><span>DM para reclamar.</span></div>`;
    MG_cta.style.display='inline-flex'; MG_cta.href=MG_IG_URL;
  } else if(kind==='p50'){
    MG_tModal.innerHTML=`<div class="MG-headline"><span class="md">¬°GANASTE</span> <span class="md MG-accent">$50!</span></div>`;
    MG_msg.innerHTML = `<div style="text-align:center"><span>Presenta la captura para canjear.</span></div>`;
    MG_cta.style.display='inline-flex'; MG_cta.href=MG_IG_URL;
  } else if(kind==='gomita'){
    MG_tModal.innerHTML=`<div class="MG-headline"><span class="md">¬°GOMITAS</span> <span class="md MG-accent-purple">GANADAS!</span></div>`;
    MG_msg.innerHTML = `<div style="text-align:center"><span style="color:#fde68a;font-weight:800">TOMA CAPTURA DE PANTALLA</span><br><span>DM para canjear.</span></div>`;
    MG_cta.style.display='inline-flex'; MG_cta.href=MG_IG_URL;
  } else {
    MG_tModal.innerHTML=`<div class="MG-headline"><span class="md">SIN PREMIO</span><br><span class="xl">ESTA VEZ</span></div>`;
    MG_msg.innerHTML = `<div style="text-align:center"><span>Sigue participando con m√°s c√≥digos.</span></div>`;
    MG_cta.style.display='none';
  }

  MG_modal.style.display='flex'; MG_ok.focus();
}
function MG_close(){
  MG_modal.style.display='none';
  MG_code1.value=''; MG_code2.value='';
  MG_codes=null; MG_tel=null; MG_ready=false;
  MG_badges(); MG_paint('Ingresa 2 c√≥digos para jugar.','#9fb0c9');
}
MG_ok.addEventListener('click',MG_close);
MG_modal.addEventListener('click',e=>{ if(e.target===MG_modal) MG_close(); });
window.addEventListener('keydown',e=>{ if(MG_modal.style.display==='flex'&&(e.key==='Escape'||e.key==='Enter')) MG_close(); });

/* ---------------- Tel√©fono (modal peque√±o) ---------------- */
function MG_validPhone(v){ const d=(v||'').replace(/\D/g,''); return d.length>=8 && d.length<=15 ? d : null; }
function MG_phoneOpen(){ MG_pErr.textContent=''; MG_pIn.value=''; MG_pModal.style.display='flex'; setTimeout(()=>MG_pIn.focus(),0); }
function MG_phoneClose(){ MG_pModal.style.display='none'; }
function MG_phoneAsk(){
  return new Promise((res,rej)=>{
    MG_phoneOpen();
    const ok=()=>{ const v=MG_validPhone(MG_pIn.value); if(!v){MG_pErr.textContent='Ingresa un tel√©fono v√°lido (8 a 15 d√≠gitos).'; return;} MG_phoneClose(); res(v); };
    const cancel=()=>{ MG_phoneClose(); rej(new Error('cancelado')); };
    MG_pOk.onclick=ok; MG_pCancel.onclick=cancel;
    MG_pModal.onclick=e=>{ if(e.target===MG_pModal) cancel(); };
    const h=e=>{ if(MG_pModal.style.display==='flex'&&e.key==='Enter') ok(); if(MG_pModal.style.display==='flex'&&e.key==='Escape') cancel(); };
    window.addEventListener('keydown',h,{once:true});
  });
}

/* ---------------- Confeti (sobre el header) ---------------- */
function MG_confetti(pal='gold'){
  const ctx = MG_canvas.getContext('2d');
  const r   = MG_canvas.getBoundingClientRect();
  MG_canvas.width  = r.width * devicePixelRatio;
  MG_canvas.height = r.height * devicePixelRatio;
  ctx.scale(devicePixelRatio,devicePixelRatio);

  const cols = pal==='gold' ? ["#ffd700","#ffb300","#ff7a00","#fff2a8"]
                            : ["#9b5cf7","#7c3aed","#c084fc","#e9d5ff"];

  const pcs = Array.from({length:120},()=>({
    x:Math.random()*r.width, y:-20-Math.random()*60,
    w:6+Math.random()*6, h:8+Math.random()*10,
    vx:-1+Math.random()*2, vy:2+Math.random()*2.5,
    rot:Math.random()*Math.PI, vr:-0.22+Math.random()*0.44,
    color:cols[(Math.random()*cols.length)|0]
  }));

  let run=true; const start=performance.now();
  function tick(t){
    if(!run) return;
    const el=t-start;
    ctx.clearRect(0,0,r.width,r.height);
    for(const p of pcs){
      p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.vy+=0.02;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
      ctx.fillStyle=p.color; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
    }
    if(el<2400) requestAnimationFrame(tick);
    else { run=false; ctx.clearRect(0,0,r.width,r.height); }
  }
  requestAnimationFrame(tick);
}
</script>


<!-- ================== FIN MEGA JUEGO ================== -->


<!-- ================== MINI JUEGO 36 CASILLAS (6x6) ================== -->
<section id="mini-juego" style="width:90%;max-width:800px;margin:24px auto;padding:16px;border-radius:15px;background:transparent;color:#eee;font-family:'Poppins',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;box-sizing:border-box;overflow:hidden;min-height:520px;position:relative;z-index:0;">
  <style>
    @media (max-width:460px){
      #mini-juego{padding:6px!important}
      #mini-juego #board{gap:6px!important}
      #mini-juego #board button{font-size:clamp(13px,4.2vw,16px)!important;border-radius:12px!important}
    }
    @media (max-width:360px){
      #mini-juego{padding:6px!important}
      #mini-juego #board{gap:5px!important}
      #mini-juego #board button{font-size:clamp(12px,4.6vw,15px)!important}
    }

    /* Tablero */
    #mini-juego #board{
      --cell:clamp(50px,13.5vw,90px);
      width:92%;
      margin:0 auto 10px;
      display:grid;
      grid-template-columns:repeat(6,minmax(0,var(--cell)));
      gap:8px;
      user-select:none
    }
    #mini-juego #board button{
      display:grid;
      place-items:center;
      aspect-ratio:1/1;
      border-radius:14px;
      border:1px solid #243041;
      background:linear-gradient(135deg,#0e1420,#0b0f18);
      color:#e7ecf3;
      font-weight:800;
      letter-spacing:.2px;
      font-size:clamp(14px,2.5vw,18px);
      cursor:pointer;
      transition:transform .18s ease,background .15s ease,border-color .15s ease,box-shadow .15s ease;
      transform-style:preserve-3d;
      padding:6px
    }
    #mini-juego #board button:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(0,0,0,.35)}
    #mini-juego #board button:disabled{opacity:.9;cursor:not-allowed;transform:none;box-shadow:none}

    #mini-juego .cell-img{width:82%;height:82%;object-fit:contain;display:block;pointer-events:none}

    /* Animaciones */
    @keyframes flip{0%{transform:rotateY(0)}50%{transform:rotateY(90deg)}100%{transform:rotateY(0)}}
    @keyframes shuffle{0%{transform:translate(0,0) rotate(0)}25%{transform:translate(1px,-1px) rotate(-1deg)}50%{transform:translate(-1px,1px) rotate(1deg)}75%{transform:translate(1px,1px) rotate(0)}100%{transform:translate(0,0) rotate(0)}}
    .is-flipping{animation:flip .5s both}
    .is-shuffling{animation:shuffle .6s ease-in-out}
    .pop{animation:pop .25s ease}
    @keyframes pop{0%{transform:scale(.92)}100%{transform:scale(1)}}

    /* Estados revelados */
    .prize-200{background:linear-gradient(145deg,#064e3b,#0b6b52)!important;border-color:#18c38a!important;box-shadow:0 8px 30px rgba(14,159,110,.25)}
    .prize-gomita{background:linear-gradient(145deg,#3b0764,#5b0aa0)!important;border-color:#9b5cf7!important;box-shadow:0 8px 30px rgba(124,58,237,.25)}
    .prize-nada{background:linear-gradient(145deg,#191c24,#1b1f2a)!important;border-color:#2d3547!important}

    /* Modal */
    #mini-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,6,12,.66);backdrop-filter:blur(2px);z-index:9999}
    #mini-modal-card{width:min(540px,92vw);border:1px solid #2b3750;border-radius:20px;box-shadow:0 24px 80px rgba(0,0,0,.45);padding:22px;background:
      radial-gradient(500px 220px at 20% 0%,rgba(99,102,241,.12),transparent 60%),
      radial-gradient(500px 220px at 80% 100%,rgba(34,197,94,.12),transparent 60%),
      #0b1220}
    #mini-modal-card.success{border-color:#16a34a;background:
      radial-gradient(600px 240px at 20% 0%,rgba(34,197,94,.12),transparent 60%),
      #071c12}
    #mini-modal-card.warn{border-color:#7c3aed;background:
      radial-gradient(600px 240px at 20% 0%,rgba(124,58,237,.14),transparent 60%),
      #13072b}
    #mini-modal-card.neutral{border-color:#475569;background:
      radial-gradient(600px 240px at 20% 0%,rgba(100,116,139,.10),transparent 60%),
      #0b1220}

    /* Headline y copy */
    #mini-modal-card .headline{
      display:block; text-align:center; line-height:1.1; margin:2px 0 8px;
      letter-spacing:.2px; font-weight:900;
    }
    #mini-modal-card .headline .xl{display:inline-block; font-size:clamp(26px,5.6vw,36px);}
    #mini-modal-card .headline .md{display:inline-block; font-size:clamp(18px,3.6vw,22px); font-weight:800; opacity:.95;}
    #mini-modal-card .headline .accent{
      background:linear-gradient(90deg,#22c55e,#86efac);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 8px 30px rgba(34,197,94,.25);
    }
    #mini-modal-card .headline .accent-purple{
      background:linear-gradient(90deg,#a78bfa,#22d3ee);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 8px 30px rgba(124,58,237,.28);
    }
    #mini-modal-title{margin:0}
    #mini-modal-msg{margin:0}

    #mini-modal-card .msg{text-align:center; margin:6px auto 10px; max-width:36ch;}
    #mini-modal-card .msg .big{display:block; font-size:clamp(16px,3.6vw,20px); font-weight:800; margin-bottom:4px;}
    #mini-modal-card .msg .note{display:block; font-size:clamp(13px,3vw,15px); opacity:.95;}
    #mini-modal-card .msg .warn{color:#fde68a; font-weight:800;}

    #mini-modal-figure{display:flex;align-items:center;justify-content:center;margin:6px 0 12px}
    #mini-modal-figure img{width:min(180px,52%);height:auto;filter:drop-shadow(0 10px 28px rgba(0,0,0,.35))}
    .cta{margin:10px auto 0;display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:10px 16px;border:1px solid #2b3750;background:#121c2e;color:#e7ecf3;font-weight:700}
    .cta:hover{transform:translateY(-1px)}
    #mini-modal-actions{display:flex;justify-content:center;gap:10px;margin-top:8px;flex-wrap:wrap}
    #mini-modal-ok{padding:10px 16px;border-radius:12px;border:1px solid #1f2937;background:#1f6feb;color:#fff;cursor:pointer;font-weight:700;min-width:120px;text-align:center}

    /* Etiquetas */
    .kicker{font-size:12px;letter-spacing:.4px;text-transform:uppercase;color:#9fb0c9;text-align:center;margin:0 0 6px}
    .subtitle{font-size:clamp(14px,2vw,16px);text-align:center;color:#cbd5e1;margin:0 0 8px}

    /* Phone modal */
    #phone-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:10000}
    .phone-card{
      width:min(440px,92vw);background:#0b1220;border:1px solid #334155;border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.4);padding:16px 14px
    }
    .phone-title{margin:0 0 6px;font-size:clamp(18px,4.8vw,20px);text-align:center}
    .phone-sub{margin:0 0 12px;opacity:.9;text-align:center}
    .phone-row{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
    .phone-input{
      flex:1;min-width:180px;max-width:260px;padding:12px 14px;border-radius:14px;border:1px solid #334155;background:#0f172a;color:#eee;outline:none;text-align:center;font-weight:700;letter-spacing:.8px
    }
    .phone-btn{padding:12px 14px;border-radius:14px;border:1px solid #1f2937;background:#1f6feb;color:#fff;cursor:pointer;font-weight:800;min-width:120px}
    .phone-btn.secondary{border:1px solid #475569;background:#1f2937;color:#e5e7eb}
    .phone-err{min-height:18px;margin-top:8px;font-size:13px;color:#fca5a5;text-align:center}
  </style>

  <!-- Header con overlay de canvas para confeti -->
  <div style="position:relative;width:100%;max-width:520px;margin:0 auto 8px;line-height:0;isolation:isolate;">
    <img src="img/gan200.png" alt="T√≠tulo" style="display:block;width:100%;height:auto;border-radius:12px">
    <canvas id="miniCanvas" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;display:block;"></canvas>
  </div>

  <p class="kicker">Tienes 1 oportunidad por c√≥digo</p>
  <div id="board"></div>

  <center>
    <div style="display:flex;width:92%;gap:8px;align-items:center;margin:10px 0 14px;flex-wrap:wrap;justify-content:center">
      <input id="codigo-input" type="text" placeholder="Ingresa tu c√≥digo" style="flex:1;min-width:220px;padding:12px 14px;border-radius:14px;border:1px solid #2b3750;background:#0f172a;color:#e7ecf3;outline:none;font-weight:600;text-align:center">
      <button id="validar-btn" style="padding:12px 16px;border-radius:14px;border:1px solid #2b3750;background:linear-gradient(135deg,#2563eb,#1f6feb);color:#fff;cursor:pointer;font-weight:800;letter-spacing:.2px">Validar y jugar</button>
    </div>
    <div id="codigo-status" class="subtitle" style="min-height:22px;margin-bottom:6px;"></div>
  </center>

  <!-- Modal de resultado -->
  <div id="mini-modal">
    <div id="mini-modal-card" class="neutral">
      <div id="mini-modal-figure" aria-hidden="true"></div>
      <h3 id="mini-modal-title" style="margin:0"></h3>
      <p id="mini-modal-msg" style="margin:0"></p>
      <div id="mini-modal-actions">
        <a id="modal-cta" class="cta" href="https://www.instagram.com/gummybank?igsh=MW82Z3hvN2VjbWYxZw%3D%3D&utm_source=qr" target="_blank" rel="noopener noreferrer" style="display:none">Abrir Instagram</a>
        <button id="mini-modal-ok">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal tel√©fono -->
  <div id="phone-modal">
    <div class="phone-card">
      <h3 class="phone-title">Confirma tu tel√©fono</h3>
      <p class="phone-sub">Para registrar tu participaci√≥n, ingresa tu n√∫mero.</p>
      <div class="phone-row">
        <input id="phone-input" class="phone-input" inputmode="tel" autocomplete="tel" maxlength="15" placeholder="8 a 15 d√≠gitos">
        <button id="phone-ok" class="phone-btn">Continuar</button>
        <button id="phone-cancel" class="phone-btn secondary">Cancelar</button>
      </div>
      <div id="phone-error" class="phone-err"></div>
    </div>
  </div>
</section>

<!-- ========= L√ìGICA (UN SOLO M√ìDULO) ========= -->
<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, serverTimestamp, setDoc,
    writeBatch, collection, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  // ====== CONFIG ======
  const IG_URL = window.IG_URL || "https://instagram.com/tu_pagina";

  const firebaseConfig = window.firebaseConfig || {
    apiKey: "AIzaSyAJJgDg5SUPvvHgPtDNhIy1f1fiGpBHBw",
    authDomain: "registro-gomitas.firebaseapp.com",
    projectId: "registro-gomitas",
    storageBucket: "registro-gomitas.appspot.com",
    messagingSenderId: "435485731864",
    appId: "1:435485731864:web:43dff09753a4c9d507e76d",
    measurementId: "G-20KEW71X9G"
  };
  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const toId = s => (s || "").trim().toUpperCase().replace(/[^A-Z0-9]/g, "");

  const TOTAL_CASILLAS=36, PREMIO_GOMITA=6, PREMIO_DINERO=2, PREMIO_NADA=TOTAL_CASILLAS-PREMIO_GOMITA-PREMIO_DINERO;

  // Jackpot control
  const JACKPOT_MIN_ATTEMPTS = 200; 


  let jackpotEnabled = false;      // se setea por consulta a Firestore
  const jackpotRef = doc(db, "minijuego_meta", "jackpot");

  async function ensureJackpotDoc() {
    await setDoc(jackpotRef, { sinceLastWin: 0 }, { merge: true });
  }
  async function readJackpotMeta() {
    const snap = await getDoc(jackpotRef);
    const d = snap.exists() ? (snap.data() || {}) : {};
    return { sinceLastWin: Number(d.sinceLastWin || 0) };
  }
  async function canEnableJackpot() {
    await ensureJackpotDoc();
    const { sinceLastWin } = await readJackpotMeta();
    return sinceLastWin >= JACKPOT_MIN_ATTEMPTS;
  }

  const $board=document.getElementById("board"),
        $status=document.getElementById("codigo-status"),
        $codigoInput=document.getElementById("codigo-input"),
        $validarBtn=document.getElementById("validar-btn"),
        $modal=document.getElementById("mini-modal"),
        $modalCard=document.getElementById("mini-modal-card"),
        $modalTitle=document.getElementById("mini-modal-title"),
        $modalMsg=document.getElementById("mini-modal-msg"),
        $modalOk=document.getElementById("mini-modal-ok"),
        $modalFigure=document.getElementById("mini-modal-figure"),
        $modalCta=document.getElementById("modal-cta"),
        $phoneModal=document.getElementById("phone-modal"),
        $phoneInput=document.getElementById("phone-input"),
        $phoneOk=document.getElementById("phone-ok"),
        $phoneCancel=document.getElementById("phone-cancel"),
        $phoneError=document.getElementById("phone-error"),
        $canvas=document.getElementById("miniCanvas");

  let codigoValido=null, telefonoValido=null, juegoHabilitado=false, yaJugo=false;

  const svgURI = s => 'data:image/svg+xml;utf8,' + encodeURIComponent(s.trim());
  const IMG = {
    HIDDEN: svgURI(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect width="120" height="120" rx="18" fill="#111827"/><text x="50%" y="56%" text-anchor="middle" dominant-baseline="middle" font-family="system-ui,Segoe UI,Roboto" font-size="64" fill="#9fb0c9">?</text></svg>`),
    X: svgURI(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect width="120" height="120" rx="18" fill="#1b2332"/><path d="M30 30 L90 90 M90 30 L30 90" stroke="#d1d5db" stroke-width="14" stroke-linecap="round"/></svg>`),
    GOMITA: 'img/gomita.png',
    P200: svgURI(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect width="120" height="120" rx="18" fill="#064e3b"/><circle cx="60" cy="60" r="36" fill="#0e9f6e"/><text x="50%" y="56%" text-anchor="middle" dominant-baseline="middle" font-family="system-ui,Segoe UI,Roboto" font-size="38" fill="#e6fffa">$200</text></svg>`)
  };

  function setIcon(btn, kind){
    const alt = kind==='P200' ? '$200' : kind==='GOMITA' ? 'Gomitas' : kind==='X' ? 'Sin premio' : 'Oculto';
    btn.innerHTML = `<img class="cell-img" alt="${alt}" src="${IMG[kind]}">`;
    btn.setAttribute('aria-label', alt);
  }
  function setRevealStyles(btn, premio){
    btn.classList.remove('prize-200','prize-gomita','prize-nada');
    if(premio==='200') btn.classList.add('prize-200');
    else if(premio==='gomita') btn.classList.add('prize-gomita');
    else btn.classList.add('prize-nada');
  }

  // Estado inicial: vitrina (puede mostrar $200 de utiler√≠a)
  mostrarPremiosIniciales();

  $validarBtn.addEventListener("click",async()=>{
    const code=toId($codigoInput.value);
    if(!code){pintarStatus("Ingresa un c√≥digo v√°lido.","#ff6b6b");bloquearTablero();return;}
    try{
      const esValido=await validarCodigoDisponible(code);
      if(!esValido){pintarStatus("C√≥digo inv√°lido o ya usado.","#ff6b6b");bloquearTablero();return;}
      codigoValido=code; juegoHabilitado=true; yaJugo=false;
      try{ telefonoValido=await pedirTelefono(); }
      catch(_){ pintarStatus("Participaci√≥n cancelada.","#fca5a5"); return; }

      // Checar si ya se habilita el $200 real
      jackpotEnabled = await canEnableJackpot();

      pintarStatus("Tienes un intento. Mezclando...","#3fb950");
      await animarVolteoYMezcla();
    }catch(e){console.error(e);pintarStatus("Error al validar.","#ff6b6b");}
  });

  // Vitrina inicial
  function mostrarPremiosIniciales(){
    const fakeShowJackpot = Math.random() < 0.7; // 70% mostrar $200 visual
    const pool = [];
    if (fakeShowJackpot) pool.push("200");
    for (let i=0;i<PREMIO_GOMITA;i++) pool.push("gomita");
    for (let i=pool.length;i<TOTAL_CASILLAS;i++) pool.push("nada");
    for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}

    $board.innerHTML="";
    pool.forEach(p=>{
      const btn=document.createElement("button");
      if(p==="200"){ setIcon(btn,'P200'); setRevealStyles(btn,'200'); }
      else if(p==="gomita"){ setIcon(btn,'GOMITA'); setRevealStyles(btn,'gomita'); }
      else{ setIcon(btn,'X'); setRevealStyles(btn,'nada'); }
      btn.disabled=true;
      $board.appendChild(btn);
    });
  }

  async function animarVolteoYMezcla(){
    const buttons=Array.from($board.children);
    await Promise.all(buttons.map((btn,i)=>new Promise(res=>{
      setTimeout(()=>{
        setIcon(btn,'HIDDEN');
        btn.classList.remove("prize-200","prize-gomita","prize-nada");
        btn.style.background="linear-gradient(135deg,#0e1420,#0b0f18)";
        btn.style.borderColor="#243041";
        res();
      },i*30);
    })));
    configurarPremiosRandom();
    buttons.forEach((btn,i)=>{setTimeout(()=>{btn.classList.add("is-shuffling");setTimeout(()=>btn.classList.remove("is-shuffling"),650);},i*12);});
    habilitarTablero();
    pintarStatus("C√≥digo validado. Elige una casilla.","#3fb950");
  }

  function bloquearTablero(){Array.from($board.children).forEach(btn=>btn.disabled=true);juegoHabilitado=false;}
  function habilitarTablero(){Array.from($board.children).forEach(btn=>btn.disabled=false);juegoHabilitado=true;}

  // Pool REAL: solo incluye $200 si el jackpot est√° habilitado
  function configurarPremiosRandom(){
    const pool = [];
    const realDinero = jackpotEnabled ? PREMIO_DINERO : 0;
    for (let i=0;i<realDinero;i++) pool.push("200");
    for (let i=0;i<PREMIO_GOMITA;i++) pool.push("gomita");
    for (let i=pool.length;i<TOTAL_CASILLAS;i++) pool.push("nada");

    for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}

    Array.from($board.children).forEach((btn,idx)=>{
      btn.dataset.premio=pool[idx];
      setIcon(btn,'HIDDEN');
      btn.disabled=false;
      btn.onclick=()=>onClickCasilla(btn);
      btn.style.background="linear-gradient(135deg,#0e1420,#0b0f18)";
      btn.style.borderColor="#243041";
    });
  }

  async function onClickCasilla(btn){
    if(!juegoHabilitado||!codigoValido||yaJugo)return;
    yaJugo=true;
    bloquearTablero();

    let premio=btn.dataset.premio;

    await revelarCasilla(btn, premio);

    try{
      await persistirResultado(codigoValido, telefonoValido, premio);
    }catch(e){
      console.error("No se pudo persistir el resultado:", e);
    }

    await revelarResto(btn);

    if (premio === "200") {
      lanzarConfeti("gold");
      openResultModal(null, null, "success", { type: "200" });
    } else if (premio === "gomita") {
      lanzarConfeti("purple");
      openResultModal(null, null, "warn", { type: "gomita" });
    } else {
      openResultModal(null, null, "neutral", { type: "nada" });
    }
  }

  function revelarCasilla(btn,premio){
    return new Promise(res=>{
      btn.classList.add("is-flipping");
      setTimeout(()=>{
        if(premio==="200"){ setIcon(btn,'P200'); setRevealStyles(btn,'200'); }
        else if(premio==="gomita"){ setIcon(btn,'GOMITA'); setRevealStyles(btn,'gomita'); }
        else { setIcon(btn,'X'); setRevealStyles(btn,'nada'); }
        btn.classList.remove("is-flipping");
        btn.classList.add("pop");
        setTimeout(()=>{btn.classList.remove("pop");res();},180);
      },180);
    });
  }

  // Revelado del resto: si NO hay $200 real y jackpot est√° deshabilitado,
  // inyecta un $200 SOLO VISUAL en una celda que NO fue elegida.
  function revelarResto(chosenBtn){
    const buttons=Array.from($board.children);
    const hasReal200 = buttons.some(b=>b.dataset.premio==='200');
    let fake200Btn = null;

    if(!hasReal200 && !jackpotEnabled){
      const others = buttons.filter(b=>b!==chosenBtn);
      fake200Btn = others[(Math.random()*others.length)|0];
    }

    let delay=120;
    const promises=[];
    for(const b of buttons){
      if(b===chosenBtn) continue;
      const premio=b.dataset.premio;

      promises.push(new Promise(r=>{
        setTimeout(()=>{
          if(fake200Btn && b===fake200Btn){
            // Mostrar $200 visual sin tocar dataset
            setIcon(b,'P200'); setRevealStyles(b,'200');
          }else if(premio==="200"){
            setIcon(b,'P200'); setRevealStyles(b,'200');
          }else if(premio==="gomita"){
            setIcon(b,'GOMITA'); setRevealStyles(b,'gomita');
          }else{
            setIcon(b,'X'); setRevealStyles(b,'nada');
          }
          r();
        }, delay);
        delay += 60;
      }));
    }
    return Promise.all(promises);
  }

  function pintarStatus(msg,color){$status.textContent=msg;$status.style.color=color||"#9fb0c9";}

  async function validarCodigoDisponible(rawCode){
    const code = toId(rawCode);
    const ref=doc(db,"codigos",code);
    const snap=await getDoc(ref);
    if(!snap.exists())return false;
    const data=snap.data()||{};
    if((data.estado||"").toLowerCase()==="usado")return false;
    return true;
  }

  // Persistencia + contador de intentos del jackpot
  async function persistirResultado(codeRaw, phone, premio){
    const code = toId(codeRaw);
    const playRef=doc(collection(db,"minijuego_plays"));
    const codeRef=doc(db,"codigos",code);

    await ensureJackpotDoc();

    await runTransaction(db, async (tx) => {
      const metaSnap = await tx.get(jackpotRef);
      const meta = metaSnap.exists() ? (metaSnap.data()||{}) : { sinceLastWin: 0 };
      const current = Number(meta.sinceLastWin||0);

      // Blindaje extremo: si llegara "200" antes del umbral, degradar a "gomita"
      let finalPremio = premio;
      if (premio === "200" && current < JACKPOT_MIN_ATTEMPTS) {
        finalPremio = "gomita";
      }

      // Escribe play
      tx.set(playRef, {
        codigo: code,
        telefono: phone,
        resultado: finalPremio,
        createdAt: serverTimestamp()
      });

      // Marca c√≥digo como usado
      tx.set(codeRef, {
        estado:"usado",
        usadoEn:"MiniJuego",
        usadoAt:serverTimestamp(),
        telefono: phone,
        resultado: finalPremio === '200' ? '200' : (finalPremio === 'gomita' ? 'gomitas' : 'sin premio')
      }, { merge:true });

      // Actualiza meta
      if (finalPremio === "200") {
        tx.set(jackpotRef, { sinceLastWin: 0 }, { merge: true });
      } else {
        tx.set(jackpotRef, { sinceLastWin: current + 1 }, { merge: true });
      }
    });
  }

  // Registro en B√≥vedas (igual que antes)
  window.handleRegistroCodigo = async ({codigo, telefono, boveda})=>{
    const code = toId(codigo);
    if(!/^[A-Z0-9]{8}$/.test(code)) { alert("C√≥digo inv√°lido."); return false; }
    if(!/^\d{10}$/.test(telefono||"")) { alert("Tel√©fono inv√°lido (10 d√≠gitos)."); return false; }
    if(!["madera","cristal","plateada","dorada"].includes(boveda)){ alert("B√≥veda inv√°lida."); return false; }

    const ref = doc(db,"codigos",code);
    const snap = await getDoc(ref);
    if(!snap.exists()){ alert("Este c√≥digo no existe."); return false; }
    const data = snap.data() || {};
    if((data.estado||"").toLowerCase()==="usado"){ alert("Este c√≥digo ya fue usado."); return false; }

    const batch = writeBatch(db);
    batch.set(ref, { estado:"usado", telefono, boveda, registradoAt: serverTimestamp() }, { merge:true });
    const destinoRef = doc(collection(db, boveda), code);
    batch.set(destinoRef, { codigo: code, telefono, boveda, registrado: serverTimestamp() });
    await batch.commit();

    try{
      const cont = document.getElementById(`tarjetas-${boveda}`);
      if(cont){
        const card = document.createElement("div");
        card.className = "card-codigo";
        card.innerHTML = `<strong>C√≥digo:</strong> ${code}<br><strong>Tel√©fono:</strong> ${telefono}`;
        cont.prepend(card);
      }
      const countEl = document.querySelector(`.vault.${boveda} .count`);
      if(countEl){ countEl.textContent = String(Number(countEl.textContent||"0") + 1); }
    }catch(_){}

    const okM = document.getElementById("customModal"), ov = document.getElementById("overlay");
    if(okM && ov){ okM.style.display="block"; ov.style.display="block"; }
    return true;
  };

  // Modal resultado
  function openResultModal(_title,_msg,variant,{type}={}){
    $modalFigure.innerHTML = "";
    $modalCard.classList.remove('success','warn','neutral');
    if(variant) $modalCard.classList.add(variant);

    if(type==="gomita"){
      const im=document.createElement('img');
      im.src=IMG.GOMITA; im.alt="Gomitas";
      $modalFigure.appendChild(im);
    }else if(type==="200"){
      const im=document.createElement('img');
      im.src=IMG.P200; im.alt="$200";
      $modalFigure.appendChild(im);
    }

    if (type === "200") {
      $modalTitle.innerHTML = `
        <div class="headline">
          <span class="md">¬°PREMIO MAYOR!</span><br>
          <span class="xl accent">$200</span>
        </div>
      `;
      $modalMsg.innerHTML = `
        <div class="msg">
          <span class="big">Te lo llevaste todo.</span>
          <span class="note warn">TOMA CAPTURA DE PANTALLA</span>
          <span class="note">Env√≠ala por DM a nuestro Instagram para reclamar tu premio.</span>
        </div>
      `;
      $modalCta.style.display='inline-flex';
      $modalCta.href = IG_URL;
      $modalCta.textContent = 'Abrir Instagram';
    } else if (type === "gomita") {
      $modalTitle.innerHTML = `
        <div class="headline">
          <span class="md">¬°GOMITAS</span> <span class="md accent-purple">GANADAS!</span>
        </div>
      `;
      $modalMsg.innerHTML = `
        <div class="msg">
          <span class="big">Dulce victoria.</span>
          <span class="note warn">TOMA CAPTURA DE PANTALLA</span>
          <span class="note">M√°ndala por DM en Instagram y reclama tus gomitas.</span>
        </div>
      `;
      $modalCta.style.display='inline-flex';
      $modalCta.href = IG_URL;
      $modalCta.textContent = 'Abrir Instagram';
    } else {
      $modalTitle.innerHTML = `
        <div class="headline">
          <span class="md">SIN PREMIO</span><br>
          <span class="xl">ESTA VEZ</span>
        </div>
      `;
      $modalMsg.innerHTML = `
        <div class="msg">
          <span class="big">Quiz√° la pr√≥xima tengas m√°s suerte.</span>
          <span class="note">Sigue participando con m√°s c√≥digos que la pr√≥xima puede ser tuya.</span>
        </div>
      `;
      $modalCta.style.display='none';
    }

    $modal.style.display='flex';
    $modalOk.focus();
  }
  function closeResultModal(){
    $modal.style.display='none';
    $codigoInput.value='';
    codigoValido=null; telefonoValido=null;
    pintarStatus('Ingresa un c√≥digo para jugar.','#9fb0c9');
  }
  $modalOk.addEventListener('click',closeResultModal);
  $modal.addEventListener('click',(e)=>{if(e.target===$modal)closeResultModal();});
  window.addEventListener('keydown',(e)=>{if($modal.style.display==='flex'&&(e.key==='Escape'||e.key==='Enter'))closeResultModal();});

  // Tel√©fono
  function validarTelefono(value){
    const digits=(value||'').replace(/\D/g,'');
    return digits.length>=8 && digits.length<=15 ? digits : null;
  }
  function abrirPhoneModal(){
    $phoneError.textContent='';
    $phoneInput.value='';
    $phoneModal.style.display='flex';
    setTimeout(()=>{$phoneInput.focus();},0);
  }
  function cerrarPhoneModal(){ $phoneModal.style.display='none'; }

  function pedirTelefono(){
    return new Promise((resolve,reject)=>{
      abrirPhoneModal();

      const onOk=()=>{
        const v=validarTelefono($phoneInput.value);
        if(!v){ $phoneError.textContent='Ingresa un tel√©fono v√°lido (8 a 15 d√≠gitos).'; return; }
        cerrarPhoneModal(); resolve(v);
      };
      const onCancel=()=>{ cerrarPhoneModal(); reject(new Error('cancelado')); };

      $phoneOk.onclick=onOk;
      $phoneCancel.onclick=onCancel;
      $phoneModal.onclick=(e)=>{ if(e.target===$phoneModal) onCancel(); };

      const handler=(e)=>{
        if($phoneModal.style.display==='flex'&&e.key==='Enter') onOk();
        if($phoneModal.style.display==='flex'&&e.key==='Escape') onCancel();
      };
      window.addEventListener('keydown',handler,{once:true});
    });
  }

  // Confeti
  function lanzarConfeti(palette='gold'){
    const ctx = $canvas.getContext('2d');
    const rect = $canvas.getBoundingClientRect();
    $canvas.width = rect.width * devicePixelRatio;
    $canvas.height = rect.height * devicePixelRatio;
    const scale = devicePixelRatio;
    ctx.scale(scale, scale);

    const colors = palette==='gold'
      ? ["#ffd700","#ffb300","#ff7a00","#fff2a8"]
      : ["#9b5cf7","#7c3aed","#c084fc","#e9d5ff"];
    const pieces = Array.from({length: 110}, ()=>({
      x: Math.random()*rect.width,
      y: -20 - Math.random()*60,
      w: 6+Math.random()*6,
      h: 8+Math.random()*10,
      vx: -1 + Math.random()*2,
      vy: 2 + Math.random()*2.5,
      rot: Math.random()*Math.PI,
      vr: -0.2 + Math.random()*0.4,
      color: colors[(Math.random()*colors.length)|0],
      life: 220 + Math.random()*120
    }));

    let running = true;
    const start = performance.now();
    function tick(t){
      if(!running) return;
      const elapsed = t - start;
      ctx.clearRect(0,0,rect.width,rect.height);
      for(const p of pieces){
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;
        p.vy += 0.02;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctx.restore();
      }
      if(elapsed < 2600) requestAnimationFrame(tick);
      else { running=false; ctx.clearRect(0,0,rect.width,rect.height); }
    }
    requestAnimationFrame(tick);
  }
</script>
<!-- ================== FIN MINI JUEGO ================== -->

<!-- Si tu main.obf.js pinta animaciones/lluvia, d√©jalo. NO incluimos funcionalidad.js para evitar choques. -->
<script src="js/main.obf.js" type="module"></script>

<!-- Contenedor de la lluvia (si ya lo tienes, omite esta l√≠nea) -->
<div id="lluvia-container" aria-hidden="true"></div>
<!-- Acceso por candado -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const lock = document.getElementById('lock-icon');
  if (!lock) {
    console.warn('No se encontr√≥ #lock-icon en el DOM.');
    return;
  }

  // Mapa de roles -> pass, token de sesi√≥n y p√°gina de destino
  const routes = {
    admin:   { pass: '1234',     token: 'auth',           page: 'admin.html' },
    panel:   { pass: '12345',     token: 'ventas_auth',    page: 'ventas.html' },
    vendedor:   { pass: '123456', token: 'vendedor_auth',  page: 'premios.html' },
    registroven:{ pass: '12345678',     token: 'registro_auth',  page: 'registro-premios.html' },
    resena:  { pass: '1',       token: 'resena_auth',    page: 'resenas.html' },
    r:       { pass: '1',       token: 'resena_auth',    page: 'resenas.html' } // alias
  };

  lock.addEventListener('click', () => {
    const u = prompt('Usuario:');      if (u == null) return;
    const p = prompt('Contrase√±a:');   if (p == null) return;

    const user = String(u).trim().toLowerCase();
    const pass = String(p).trim();
    const cfg  = routes[user];

    if (cfg && pass === cfg.pass) {
      sessionStorage.setItem(cfg.token, 'true');
      window.location.href = cfg.page;
    } else {
      alert('Acceso denegado. Usuario o contrase√±a incorrectos.');
    }
  });
});
</script>

<!-- Lluvia de gomitas: script independiente, SIN type="module" -->
<script>
(() => {
  // Usa el contenedor existente o crea uno silenciosamente
  const cont = document.getElementById('lluvia-container') || (() => {
    const d = document.createElement('div');
    d.id = 'lluvia-container';
    d.setAttribute('aria-hidden','true');
    document.body.appendChild(d);
    return d;
  })();

  function crearLluviaImagen() {
    const img = new Image();
    img.src = './img/gomita.png';   // cambia la ruta si la imagen vive en otro lado
    img.alt = '';
    img.className = 'gomita';

    // Posici√≥n y duraci√≥n aleatorias
    img.style.left = (Math.random() * window.innerWidth) + 'px';
    img.style.animationDuration = (2 + Math.random() * 3) + 's';

    cont.appendChild(img);

    // Limpieza al terminar la animaci√≥n o por seguridad a los 7s
    const kill = () => img.remove();
    img.addEventListener('animationend', kill, { once: true });
    setTimeout(kill, 7000);
  }

  // Lluvia continua
  let timer = setInterval(crearLluviaImagen, 250);

  // Pausa cuando la pesta√±a no est√° visible (ahorra CPU)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      clearInterval(timer);
      timer = null;
    } else if (!timer) {
      timer = setInterval(crearLluviaImagen, 250);
    }
  });
})();
</script>
<style>
 /* Lluvia visible pero detr√°s del contenido */
#lluvia-container{
  position: fixed;
  inset: 0;
  z-index: 0;           /* detr√°s del contenido */
  pointer-events: none; /* no bloquea clics */
  overflow: hidden;
}

/* Todo tu contenido normal por encima */
header, main, section, footer, .vault, .gb-review-card{
  position: relative;
  z-index: 1;
}

/* Modales siguen dominando */
.modal-overlay{ position:fixed; inset:0; z-index:10040; }
.custom-modal{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:10050; }

</style>


<!-- Modal de informaci√≥n -->
<div class="modal-info" id="infoModal" style="display:none">
  <div class="modal-content-info">
    <center><h3>Instrucciones y Condiciones</h3></center>
    <p><strong>¬øC√≥mo participar?</strong>
    <ul>
      <li>Compra tu bolsita de gomitas con c√≥digo √∫nico.
      <li>Da clic en <strong>Registrar C√≥digo</strong> en la b√≥veda que desees participar.
      <li>Ingresa el c√≥digo y tu n√∫mero de tel√©fono.
      <li>Espera a que se llene la b√≥veda para el sorteo.
    </ul>

    <p><strong>Tipos de b√≥vedas</strong>
    <ul>
      <li>ü™µ <strong>Madera</strong>: 25 c√≥digos
      <li>üîπ <strong>Cristal</strong>: 100 c√≥digos
      <li>‚ö™ <strong>Plateada</strong>: 250 c√≥digos
      <li>üü° <strong>Dorada</strong>: 500 c√≥digos
    </ul>

    <p><strong>Reglas importantes</strong>
    <ul>
      <li>Cada c√≥digo es √∫nico y solo se usa una vez.
      <li>Cada c√≥digo se puede registrar en una sola b√≥veda.
      <li>Si ganas y no respondes en 24 horas, tu premio ser√° sorteado nuevamente.
      <li>Para reclamar tu premio debes seguir la p√°gina de Instagram gummybank_.
    </ul>

    <p><strong>Privacidad</strong>
    <ul><li>Tu n√∫mero solo se usa para contactarte si eres ganador.</ul>

    <center><h2>¬°Suerte!</h2></center>
    <button onclick="cerrarInfoModal()">Cerrar</button>
  </div>
</div>
<div class="modal-overlay" id="overlay-info" style="display:none"></div>

<footer style="text-align:center;margin-top:40px;padding:20px;color:#aaa;font-size:.9rem">
  ¬© 2025 Gummy Bank. All rights reserved<br/>Moy and Juan
</footer>

    </main>
  </body>
</html>
